<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alloy Journey Application Demo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="css/styles.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <script src="js/faker-bundle.js"></script>
    <link rel="stylesheet" href="vendor/shepherd.css">
    <script src="https://cdn.jsdelivr.net/npm/shepherd.js@latest/dist/js/shepherd.min.js"></script>
    <script src="js/modals.js"></script>
    <script type="module" src="js/alloy-app.js"></script>
</head>
<body>
    <!-- Processing Modal -->
    <div id="processingModal" class="modal-overlay">
        <div class="modal-content">
            <div class="spinner"></div>
            <h4 id="processingMessage">Processing...</h4>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deletePersonModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Confirm Deletion</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this person? This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary me-2" id="cancelDelete">
                    <i class="fas fa-ban"></i> Cancel
                </button>
                <button type="button" class="btn btn-danger" id="confirmDelete">
                    <i class="fas fa-trash"></i> Delete Person
                </button>
            </div>
        </div>
    </div>

    <!-- Delete Business Confirmation Modal -->
    <div id="deleteBusinessModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Confirm Business Deletion</h4>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this business? This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary me-2" id="cancelDeleteBusiness">
                    <i class="fas fa-ban"></i> Cancel
                </button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBusiness">
                    <i class="fas fa-trash"></i> Delete Business
                </button>
            </div>
        </div>
    </div>

    <!-- Sandbox Profile Person Selection Modal -->
    <div id="sandboxProfileModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h4 class="modal-title">Apply Sandbox Profile</h4>
            </div>
            <div class="modal-body">
                <p>Select which person(s) to apply the profile to:</p>
                <div id="sandboxProfilePersonList" class="mb-3"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary me-2" id="cancelSandboxProfile">
                    <i class="fas fa-ban"></i> Cancel
                </button>
                <button type="button" class="btn btn-primary" id="confirmSandboxProfile">
                    <i class="fas fa-check"></i> Apply
                </button>
            </div>
        </div>
    </div>

    <!-- Header -->
<header class="app-header">
    <div class="header-content">
        <div class="header-title d-flex flex-column align-items-start">
            <img src="/img/alloy-logo_white.png" alt="Alloy Logo" class="header-logo-img" style="max-width: 220px; height: auto; margin-bottom: -1rem;">
            <h2 class="mt-2 mb-0" style="font-weight: 600; margin-left: 4px;">Demo Application</h2>
        </div>
    </div>
</header>

    <!-- Keyboard Shortcuts Info Button -->
    <button id="keyboardShortcutsBtn" class="keyboard-shortcuts-btn" title="Settings & Shortcuts">
        <i class="fas fa-cog"></i>
        <span>Settings & Shortcuts</span>
    </button>

    <!-- Keyboard Shortcuts Modal -->
    <div id="keyboardShortcutsModal" class="modal fade modal-bottom-right" tabindex="-1">
        <div class="modal-dialog modal-dialog-bottom-right">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title">Settings & Shortcuts</h4>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="settings-section mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <span>Dark Mode</span>
                            <button type="button" class="btn btn-outline-primary" id="toggleDarkMode">
                                <i class="fas fa-moon"></i>
                                <span id="darkModeToggleText">Off</span>
                            </button>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <span>Developer View</span>
                            <button type="button" class="btn btn-outline-primary" id="toggleDevMode">
                                <i class="fas fa-code"></i>
                                <span id="devModeToggleText">Off</span>
                            </button>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mt-3">
                            <span>Delete App History</span>
                            <button type="button" class="btn btn-outline-danger" id="clearStorageBtn">
                                <i class="fas fa-trash-alt"></i>
                                <span>Clear</span>
                            </button>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mt-3">
                            <span>Edit Configuration</span>
                            <a href="/config.html" class="btn btn-outline-primary" id="editConfigBtn">
                                <i class="fas fa-cog"></i>
                                <span>Edit</span>
                            </a>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mt-3">
                            <span>Take a Tour</span>
                            <button type="button" class="btn btn-outline-primary" id="takeTourBtn">
                                <i class="fas fa-route"></i>
                                <span>Tour</span>
                            </button>
                        </div>
                    </div>
                    <div class="shortcuts-section">
                        <h5 class="mb-3">Keyboard Shortcuts</h5>
                        <div class="shortcut-item">
                            <span class="shortcut-key">⌘/Ctrl + ,</span>
                            <span class="shortcut-description">Open Settings & Shortcuts</span>
                        </div>
                        <div class="shortcut-item">
                            <span class="shortcut-key">⌘/Ctrl + Shift + F</span>
                            <span class="shortcut-description">Pre-fill Dummy Data</span>
                        </div>
                        <div class="shortcut-item">
                            <span class="shortcut-key">⌘/Ctrl + Shift + I</span>
                            <span class="shortcut-description">Add Person</span>
                        </div>
                        <div class="shortcut-item">
                            <span class="shortcut-key">⌘/Ctrl + Shift + B</span>
                            <span class="shortcut-description">Add Business</span>
                        </div>
                        <div class="shortcut-item">
                            <span class="shortcut-key">⌘/Ctrl + Shift + A</span>
                            <span class="shortcut-description">Add Representative</span>
                        </div>
                        <div class="shortcut-item">
                            <span class="shortcut-key">⌘/Ctrl + Enter</span>
                            <span class="shortcut-description">Submit Application</span>
                        </div>
                        <div class="shortcut-item">
                            <span class="shortcut-key">⌘/Ctrl + Shift + E</span>
                            <span class="shortcut-description">Re-run Last App</span>
                        </div>
                        <div class="shortcut-item">
                            <span class="shortcut-key">⌘/Ctrl + Shift + M</span>
                            <span class="shortcut-description">Toggle Dark Mode</span>
                        </div>
                        <div class="shortcut-item">
                            <span class="shortcut-key">⌘/Ctrl + Shift + V</span>
                            <span class="shortcut-description">Toggle Developer</span>
                        </div>
                        <div class="shortcut-item">
                            <span class="shortcut-key">⌘/Ctrl + Shift + D</span>
                            <span class="shortcut-description">Delete App History</span>
                        </div>
                        <div class="shortcut-item">
                            <span class="shortcut-key">⌘/Ctrl + Shift + L</span>
                            <span class="shortcut-description">Open App History</span>
                        </div>
                        <div class="shortcut-item">
                            <span class="shortcut-key">Esc</span>
                            <span class="shortcut-description">Close Modals</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="app-container">
        <div class="form-section">
            <div class="form-header d-flex flex-column mb-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h2 class="mb-0"><i class="fas fa-user-plus form-icon"></i>Application Form</h2>
                    <div class="d-flex align-items-center">
                        <button type="button" class="btn btn-light me-2" id="toggleAllEntitiesBtn" title="Collapse All">
                            <i class="fas fa-compress-alt"></i>
                        </button>
                        <button type="button" class="btn btn-success me-2" id="addPersonBtn">
                            <i class="fas fa-user-plus"></i> Add Person
                        </button>
                        <button type="button" class="btn btn-primary" id="addBusinessBtn">
                            <i class="fas fa-building"></i> Add Business
                        </button>
                    </div>
                </div>
                <div class="d-flex align-items-center mb-4" id="sandboxProfilesSection">
                    <!-- Sandbox Profiles Dropdown (add custom profiles section and search input) -->
                    <div class="dropdown d-inline-block me-2">
                        <button type="button" class="btn btn-info dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-gear"></i> Sandbox Profiles
                        </button>
                        <div class="dropdown-menu p-2" style="min-width: 300px;">
                            <!-- Search input for filtering profiles -->
                            <input type="text" class="form-control mb-2" id="profileSearch" placeholder="Search profiles...">
                            <!-- Custom Profiles Section -->
                            <div id="customProfilesSection" class="mb-3">
                                <h6 class="dropdown-header text-success mb-2"><i class="fas fa-user-cog me-2"></i>Custom Profiles</h6>
                                <div id="customProfilesList"></div>
                                <button id="addCustomProfileBtn" class="btn btn-sm btn-success w-100 mt-2"><i class="fas fa-plus"></i> Add Custom Profile</button>
                            </div>
                            <!-- Default Profiles Section -->
                            <div id="profileList" style="max-height: 300px; overflow-y: auto;"></div>
                        </div>
                    </div>
                    <button type="button" class="btn btn-secondary" id="prefillBtn">
                        <i class="fas fa-user"></i> Pre-fill Dummy Data
                    </button>
                </div>
            </div>
            
            <!-- Profile Indicator -->
            <div id="profileIndicator" class="alert alert-info d-none mb-4">
                <div class="d-flex align-items-center">
                    <i class="fas fa-info-circle me-2"></i>
                    <div>
                        <strong>Active Profile:</strong>
                        <span id="profileName"></span>
                        <br>
                        <small id="profileDescription" class="text-muted"></small>
                    </div>
                </div>
            </div>

            <!-- Business Form (hidden by default) -->
            <div id="businessFormContainer" style="display:none;">
                <div class="collapsible-entity expanded" id="businessEntity">
                    <div class="collapsible-header d-flex justify-content-between align-items-center">
                        <h3 class="mb-0">Business</h3>
                        <div>
                            <button type="button" class="btn btn-link btn-toggle-entity" data-target="#businessFormCollapse" aria-expanded="true" aria-controls="businessFormCollapse">
                                <i class="fas fa-chevron-down"></i>
                            </button>
                            <button type="button" class="btn btn-danger delete-business">
                                <i class="fas fa-trash"></i> Delete Business
                            </button>
                        </div>
                    </div>
                    <div class="collapsible-body show" id="businessFormCollapse">
                        <form class="business-form mb-4">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">Business Name</label>
                                    <input type="text" class="form-control" name="business_name" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Business Type</label>
                                    <input type="text" class="form-control" name="business_type" required>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">Federal EIN</label>
                                    <input type="text" class="form-control" name="business_federal_ein" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Business Phone</label>
                                    <input type="tel" class="form-control" name="business_phone_number" required>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">Registry ID</label>
                                    <input type="text" class="form-control" name="business_registry_id">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Website</label>
                                    <input type="url" class="form-control" name="business_url">
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Alternate Name</label>
                                <input type="text" class="form-control" name="business_alternate_name">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Street Address</label>
                                <input type="text" class="form-control" name="line_1" required>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-3">
                                    <label class="form-label">City</label>
                                    <input type="text" class="form-control" name="city" required>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">State/Province/Region</label>
                                    <input type="text" class="form-control" name="state">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">ZIP</label>
                                    <input type="text" class="form-control" name="postal_code" required>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Country</label>
                                    <select name="country_code" class="form-control" required>
                                      <option value="">Select Country</option>
                                      <option value="US">United States</option>
                                      <option value="CA">Canada</option>
                                      <option value="GB">United Kingdom</option>
                                      <option value="AU">Australia</option>
                                      <option value="DE">Germany</option>
                                      <option value="FR">France</option>
                                      <option value="IN">India</option>
                                      <option value="JP">Japan</option>
                                      <option value="CN">China</option>
                                      <option value="BR">Brazil</option>
                                      <option value="ZA">South Africa</option>
                                      <option value="MX">Mexico</option>
                                      <option value="RU">Russia</option>
                                      <option value="IT">Italy</option>
                                      <option value="ES">Spain</option>
                                      <option value="SG">Singapore</option>
                                      <option value="KR">South Korea</option>
                                      <option value="SE">Sweden</option>
                                      <option value="CH">Switzerland</option>
                                      <option value="NL">Netherlands</option>
                                      <option value="NZ">New Zealand</option>
                                      <option value="IE">Ireland</option>
                                      <option value="AR">Argentina</option>
                                      <option value="BE">Belgium</option>
                                      <option value="DK">Denmark</option>
                                      <option value="FI">Finland</option>
                                      <option value="NO">Norway</option>
                                      <option value="PL">Poland</option>
                                      <option value="PT">Portugal</option>
                                      <option value="TR">Turkey</option>
                                      <option value="UA">Ukraine</option>
                                      <option value="AE">United Arab Emirates</option>
                                      <option value="SA">Saudi Arabia</option>
                                      <option value="IL">Israel</option>
                                      <option value="TH">Thailand</option>
                                      <option value="MY">Malaysia</option>
                                      <option value="ID">Indonesia</option>
                                      <option value="PH">Philippines</option>
                                      <option value="EG">Egypt</option>
                                      <option value="NG">Nigeria</option>
                                      <option value="KE">Kenya</option>
                                      <option value="GH">Ghana</option>
                                      <option value="PK">Pakistan</option>
                                      <option value="BD">Bangladesh</option>
                                      <option value="VN">Vietnam</option>
                                      <option value="CO">Colombia</option>
                                      <option value="CL">Chile</option>
                                      <option value="PE">Peru</option>
                                      <option value="VE">Venezuela</option>
                                      <option value="CZ">Czech Republic</option>
                                      <option value="HU">Hungary</option>
                                      <option value="RO">Romania</option>
                                      <option value="GR">Greece</option>
                                      <option value="SK">Slovakia</option>
                                      <option value="BG">Bulgaria</option>
                                      <option value="HR">Croatia</option>
                                      <option value="SI">Slovenia</option>
                                      <option value="EE">Estonia</option>
                                      <option value="LT">Lithuania</option>
                                      <option value="LV">Latvia</option>
                                      <option value="LU">Luxembourg</option>
                                      <option value="MT">Malta</option>
                                      <option value="CY">Cyprus</option>
                                      <option value="IS">Iceland</option>
                                      <option value="MC">Monaco</option>
                                      <option value="LI">Liechtenstein</option>
                                      <option value="SM">San Marino</option>
                                      <option value="VA">Vatican City</option>
                                      <option value="QA">Qatar</option>
                                      <option value="KW">Kuwait</option>
                                      <option value="OM">Oman</option>
                                      <option value="BH">Bahrain</option>
                                      <option value="JO">Jordan</option>
                                      <option value="LB">Lebanon</option>
                                      <option value="IQ">Iraq</option>
                                      <option value="IR">Iran</option>
                                      <option value="AF">Afghanistan</option>
                                      <option value="LK">Sri Lanka</option>
                                      <option value="NP">Nepal</option>
                                      <option value="MM">Myanmar</option>
                                      <option value="KH">Cambodia</option>
                                      <option value="LA">Laos</option>
                                      <option value="MN">Mongolia</option>
                                      <option value="UZ">Uzbekistan</option>
                                      <option value="KZ">Kazakhstan</option>
                                      <option value="KG">Kyrgyzstan</option>
                                      <option value="TJ">Tajikistan</option>
                                      <option value="TM">Turkmenistan</option>
                                      <option value="AZ">Azerbaijan</option>
                                      <option value="GE">Georgia</option>
                                      <option value="AM">Armenia</option>
                                      <option value="MD">Moldova</option>
                                      <option value="BY">Belarus</option>
                                      <option value="RS">Serbia</option>
                                      <option value="ME">Montenegro</option>
                                      <option value="AL">Albania</option>
                                      <option value="MK">North Macedonia</option>
                                      <option value="BA">Bosnia and Herzegovina</option>
                                      <option value="ZW">Zimbabwe</option>
                                      <option value="ZM">Zambia</option>
                                      <option value="UG">Uganda</option>
                                      <option value="TZ">Tanzania</option>
                                      <option value="SD">Sudan</option>
                                      <option value="SS">South Sudan</option>
                                      <option value="ET">Ethiopia</option>
                                      <option value="DZ">Algeria</option>
                                      <option value="MA">Morocco</option>
                                      <option value="TN">Tunisia</option>
                                      <option value="LY">Libya</option>
                                      <option value="CM">Cameroon</option>
                                      <option value="CI">Ivory Coast</option>
                                      <option value="SN">Senegal</option>
                                      <option value="AO">Angola</option>
                                      <option value="MZ">Mozambique</option>
                                      <option value="BW">Botswana</option>
                                      <option value="NA">Namibia</option>
                                      <option value="MG">Madagascar</option>
                                      <option value="MW">Malawi</option>
                                      <option value="LS">Lesotho</option>
                                      <option value="SZ">Eswatini</option>
                                      <option value="GM">Gambia</option>
                                      <option value="SL">Sierra Leone</option>
                                      <option value="LR">Liberia</option>
                                      <option value="GA">Gabon</option>
                                      <option value="CG">Congo</option>
                                      <option value="CD">DR Congo</option>
                                      <option value="CF">Central African Republic</option>
                                      <option value="NE">Niger</option>
                                      <option value="ML">Mali</option>
                                      <option value="BF">Burkina Faso</option>
                                      <option value="TD">Chad</option>
                                      <option value="MR">Mauritania</option>
                                      <option value="SO">Somalia</option>
                                      <option value="DJ">Djibouti</option>
                                      <option value="ER">Eritrea</option>
                                      <option value="RW">Rwanda</option>
                                      <option value="BI">Burundi</option>
                                      <option value="SZ">Eswatini</option>
                                      <option value="SC">Seychelles</option>
                                      <option value="MU">Mauritius</option>
                                      <option value="KM">Comoros</option>
                                      <option value="ST">Sao Tome and Principe</option>
                                      <option value="CV">Cabo Verde</option>
                                      <option value="GQ">Equatorial Guinea</option>
                                      <option value="GW">Guinea-Bissau</option>
                                      <option value="GN">Guinea</option>
                                      <option value="BJ">Benin</option>
                                      <option value="TG">Togo</option>
                                      <option value="RE">Reunion</option>
                                      <option value="YT">Mayotte</option>
                                      <option value="PM">Saint Pierre and Miquelon</option>
                                      <option value="GL">Greenland</option>
                                      <option value="FO">Faroe Islands</option>
                                      <option value="GI">Gibraltar</option>
                                      <option value="JE">Jersey</option>
                                      <option value="GG">Guernsey</option>
                                      <option value="IM">Isle of Man</option>
                                      <option value="AX">Aland Islands</option>
                                      <option value="BQ">Caribbean Netherlands</option>
                                      <option value="CW">Curacao</option>
                                      <option value="SX">Sint Maarten</option>
                                      <option value="BL">Saint Barthelemy</option>
                                      <option value="MF">Saint Martin</option>
                                      <option value="GP">Guadeloupe</option>
                                      <option value="MQ">Martinique</option>
                                      <option value="GF">French Guiana</option>
                                      <option value="PF">French Polynesia</option>
                                      <option value="NC">New Caledonia</option>
                                      <option value="WF">Wallis and Futuna</option>
                                      <option value="TF">French Southern Territories</option>
                                      <option value="BV">Bouvet Island</option>
                                      <option value="HM">Heard Island and McDonald Islands</option>
                                      <option value="GS">South Georgia and the South Sandwich Islands</option>
                                      <option value="AQ">Antarctica</option>
                                    </select>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Meta Data (JSON)</label>
                                <textarea class="form-control" name="meta" rows="3" placeholder='{"key": "value"}'></textarea>
                                <div class="invalid-feedback">Please enter valid JSON</div>
                                <div class="json-help text-danger" style="display:none;">Invalid JSON. Please enter a valid JSON object, e.g. {"key": "value"}</div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Add Representative Button and Forms Section -->
            <div class="mb-4" id="addRepresentativeContainer" style="display: none;">
                <button type="button" class="btn btn-primary" id="addRepresentativeBtn">
                    <i class="fas fa-user-plus"></i> Add Representative
                </button>
            </div>
            <div id="representativeSectionContainer" style="display: none;">
                <div id="representativeForms" class="mb-4">
                    <!-- Representative forms will be added here -->
                </div>
            </div>

            <!-- Representative Form Template (hidden) -->
            <div id="representativeFormTemplate" style="display: none;">
                <div class="collapsible-entity expanded">
                    <div class="collapsible-header d-flex justify-content-between align-items-center">
                        <h3 class="mb-0">Representative</h3>
                        <div>
                            <button type="button" class="btn btn-link btn-toggle-entity" data-target="#representativeFormCollapse" aria-expanded="true" aria-controls="representativeFormCollapse">
                                <i class="fas fa-chevron-down"></i>
                            </button>
                            <button type="button" class="btn btn-danger delete-representative">
                                <i class="fas fa-trash"></i> Delete Representative
                            </button>
                        </div>
                    </div>
                    <div class="collapsible-body show">
                        <form class="representative-form mb-4">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">First Name</label>
                                    <input type="text" class="form-control" name="name_first" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Last Name</label>
                                    <input type="text" class="form-control" name="name_last" required>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Email</label>
                                <input type="email" class="form-control" name="email_address" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Phone</label>
                                <input type="tel" class="form-control" name="phone_number" inputmode="numeric" pattern="^\\+?[1-9]\\d{1,14}$" placeholder="+1234567890" required oninput="this.value=this.value.replace(/[^0-9]/g,'')">
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">SSN</label>
                                    <input type="password" class="form-control ssn-input" name="document_ssn" maxlength="9" required oninput="this.value=this.value.replace(/[^0-9]/g,'')">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Date of Birth</label>
                                    <input type="text" class="form-control" name="birth_date" required placeholder="YYYY-MM-DD" maxlength="10" autocomplete="off" inputmode="numeric" pattern="\d{4}-\d{2}-\d{2}">
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Street Address</label>
                                <input type="text" class="form-control" name="line_1" required>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-3">
                                    <label class="form-label">City</label>
                                    <input type="text" class="form-control" name="city" required>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">State/Province/Region</label>
                                    <input type="text" class="form-control" name="state">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">ZIP</label>
                                    <input type="text" class="form-control" name="postal_code" required>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Country</label>
                                    <select name="country_code" class="form-control" required>
                                      <option value="">Select Country</option>
                                      <option value="US">United States</option>
                                      <option value="CA">Canada</option>
                                      <option value="GB">United Kingdom</option>
                                      <option value="AU">Australia</option>
                                      <option value="DE">Germany</option>
                                      <option value="FR">France</option>
                                      <option value="IN">India</option>
                                      <option value="JP">Japan</option>
                                      <option value="CN">China</option>
                                      <option value="BR">Brazil</option>
                                      <option value="ZA">South Africa</option>
                                      <option value="MX">Mexico</option>
                                      <option value="RU">Russia</option>
                                      <option value="IT">Italy</option>
                                      <option value="ES">Spain</option>
                                      <option value="SG">Singapore</option>
                                      <option value="KR">South Korea</option>
                                      <option value="SE">Sweden</option>
                                      <option value="CH">Switzerland</option>
                                      <option value="NL">Netherlands</option>
                                      <option value="NZ">New Zealand</option>
                                      <option value="IE">Ireland</option>
                                      <option value="AR">Argentina</option>
                                      <option value="BE">Belgium</option>
                                      <option value="DK">Denmark</option>
                                      <option value="FI">Finland</option>
                                      <option value="NO">Norway</option>
                                      <option value="PL">Poland</option>
                                      <option value="PT">Portugal</option>
                                      <option value="TR">Turkey</option>
                                      <option value="UA">Ukraine</option>
                                      <option value="AE">United Arab Emirates</option>
                                      <option value="SA">Saudi Arabia</option>
                                      <option value="IL">Israel</option>
                                      <option value="TH">Thailand</option>
                                      <option value="MY">Malaysia</option>
                                      <option value="ID">Indonesia</option>
                                      <option value="PH">Philippines</option>
                                      <option value="EG">Egypt</option>
                                      <option value="NG">Nigeria</option>
                                      <option value="KE">Kenya</option>
                                      <option value="GH">Ghana</option>
                                      <option value="PK">Pakistan</option>
                                      <option value="BD">Bangladesh</option>
                                      <option value="VN">Vietnam</option>
                                      <option value="CO">Colombia</option>
                                      <option value="CL">Chile</option>
                                      <option value="PE">Peru</option>
                                      <option value="VE">Venezuela</option>
                                      <option value="CZ">Czech Republic</option>
                                      <option value="HU">Hungary</option>
                                      <option value="RO">Romania</option>
                                      <option value="GR">Greece</option>
                                      <option value="SK">Slovakia</option>
                                      <option value="BG">Bulgaria</option>
                                      <option value="HR">Croatia</option>
                                      <option value="SI">Slovenia</option>
                                      <option value="EE">Estonia</option>
                                      <option value="LT">Lithuania</option>
                                      <option value="LV">Latvia</option>
                                      <option value="LU">Luxembourg</option>
                                      <option value="MT">Malta</option>
                                      <option value="CY">Cyprus</option>
                                      <option value="IS">Iceland</option>
                                      <option value="MC">Monaco</option>
                                      <option value="LI">Liechtenstein</option>
                                      <option value="SM">San Marino</option>
                                      <option value="VA">Vatican City</option>
                                      <option value="QA">Qatar</option>
                                      <option value="KW">Kuwait</option>
                                      <option value="OM">Oman</option>
                                      <option value="BH">Bahrain</option>
                                      <option value="JO">Jordan</option>
                                      <option value="LB">Lebanon</option>
                                      <option value="IQ">Iraq</option>
                                      <option value="IR">Iran</option>
                                      <option value="AF">Afghanistan</option>
                                      <option value="LK">Sri Lanka</option>
                                      <option value="NP">Nepal</option>
                                      <option value="MM">Myanmar</option>
                                      <option value="KH">Cambodia</option>
                                      <option value="LA">Laos</option>
                                      <option value="MN">Mongolia</option>
                                      <option value="UZ">Uzbekistan</option>
                                      <option value="KZ">Kazakhstan</option>
                                      <option value="KG">Kyrgyzstan</option>
                                      <option value="TJ">Tajikistan</option>
                                      <option value="TM">Turkmenistan</option>
                                      <option value="AZ">Azerbaijan</option>
                                      <option value="GE">Georgia</option>
                                      <option value="AM">Armenia</option>
                                      <option value="MD">Moldova</option>
                                      <option value="BY">Belarus</option>
                                      <option value="RS">Serbia</option>
                                      <option value="ME">Montenegro</option>
                                      <option value="AL">Albania</option>
                                      <option value="MK">North Macedonia</option>
                                      <option value="BA">Bosnia and Herzegovina</option>
                                      <option value="ZW">Zimbabwe</option>
                                      <option value="ZM">Zambia</option>
                                      <option value="UG">Uganda</option>
                                      <option value="TZ">Tanzania</option>
                                      <option value="SD">Sudan</option>
                                      <option value="SS">South Sudan</option>
                                      <option value="ET">Ethiopia</option>
                                      <option value="DZ">Algeria</option>
                                      <option value="MA">Morocco</option>
                                      <option value="TN">Tunisia</option>
                                      <option value="LY">Libya</option>
                                      <option value="CM">Cameroon</option>
                                      <option value="CI">Ivory Coast</option>
                                      <option value="SN">Senegal</option>
                                      <option value="AO">Angola</option>
                                      <option value="MZ">Mozambique</option>
                                      <option value="BW">Botswana</option>
                                      <option value="NA">Namibia</option>
                                      <option value="MG">Madagascar</option>
                                      <option value="MW">Malawi</option>
                                      <option value="LS">Lesotho</option>
                                      <option value="SZ">Eswatini</option>
                                      <option value="GM">Gambia</option>
                                      <option value="SL">Sierra Leone</option>
                                      <option value="LR">Liberia</option>
                                      <option value="GA">Gabon</option>
                                      <option value="CG">Congo</option>
                                      <option value="CD">DR Congo</option>
                                      <option value="CF">Central African Republic</option>
                                      <option value="NE">Niger</option>
                                      <option value="ML">Mali</option>
                                      <option value="BF">Burkina Faso</option>
                                      <option value="TD">Chad</option>
                                      <option value="MR">Mauritania</option>
                                      <option value="SO">Somalia</option>
                                      <option value="DJ">Djibouti</option>
                                      <option value="ER">Eritrea</option>
                                      <option value="RW">Rwanda</option>
                                      <option value="BI">Burundi</option>
                                      <option value="SZ">Eswatini</option>
                                      <option value="SC">Seychelles</option>
                                      <option value="MU">Mauritius</option>
                                      <option value="KM">Comoros</option>
                                      <option value="ST">Sao Tome and Principe</option>
                                      <option value="CV">Cabo Verde</option>
                                      <option value="GQ">Equatorial Guinea</option>
                                      <option value="GW">Guinea-Bissau</option>
                                      <option value="GN">Guinea</option>
                                      <option value="BJ">Benin</option>
                                      <option value="TG">Togo</option>
                                      <option value="RE">Reunion</option>
                                      <option value="YT">Mayotte</option>
                                      <option value="PM">Saint Pierre and Miquelon</option>
                                      <option value="GL">Greenland</option>
                                      <option value="FO">Faroe Islands</option>
                                      <option value="GI">Gibraltar</option>
                                      <option value="JE">Jersey</option>
                                      <option value="GG">Guernsey</option>
                                      <option value="IM">Isle of Man</option>
                                      <option value="AX">Aland Islands</option>
                                      <option value="BQ">Caribbean Netherlands</option>
                                      <option value="CW">Curacao</option>
                                      <option value="SX">Sint Maarten</option>
                                      <option value="BL">Saint Barthelemy</option>
                                      <option value="MF">Saint Martin</option>
                                      <option value="GP">Guadeloupe</option>
                                      <option value="MQ">Martinique</option>
                                      <option value="GF">French Guiana</option>
                                      <option value="PF">French Polynesia</option>
                                      <option value="NC">New Caledonia</option>
                                      <option value="WF">Wallis and Futuna</option>
                                      <option value="TF">French Southern Territories</option>
                                      <option value="BV">Bouvet Island</option>
                                      <option value="HM">Heard Island and McDonald Islands</option>
                                      <option value="GS">South Georgia and the South Sandwich Islands</option>
                                      <option value="AQ">Antarctica</option>
                                    </select>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Meta Data (JSON)</label>
                                <textarea class="form-control" name="meta" rows="3" placeholder='{"key": "value"}'></textarea>
                                <div class="invalid-feedback">Please enter valid JSON</div>
                                <div class="json-help text-danger" style="display:none;">Invalid JSON. Please enter a valid JSON object, e.g. {"key": "value"}</div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Status Messages -->
            <div id="approvedMessage" class="status-message approved">
                <div class="icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <h3>Application Approved! 🎉</h3>
                <p>Congratulations! Your application has been approved.</p>
                <p>We're excited to have you on board!</p>
                <div class="mt-3">
                    <button type="button" class="btn btn-primary btn-lg" id="rerunLastAppBtn">
                        <i class="fas fa-redo"></i> Re-run Last App
                    </button>
                    <button type="button" class="btn btn-secondary btn-lg ms-2 run-another-app-btn">
                        <i class="fas fa-plus"></i> Run another application
                    </button>
                </div>
            </div>

            <div id="deniedMessage" class="status-message denied">
                <div class="icon">
                    <i class="fas fa-times-circle"></i>
                </div>
                <h3>Application Not Approved ❌</h3>
                <p>We're sorry, but we are unable to approve your application at this time.</p>
                <p>This decision was made based on our verification process and current eligibility criteria.</p>
                <p>If you believe this is an error, please contact our support team.</p>
                <div class="mt-3">
                    <button type="button" class="btn btn-primary btn-lg" id="rerunLastAppBtn">
                        <i class="fas fa-redo"></i> Re-run Last App
                    </button>
                    <button type="button" class="btn btn-secondary btn-lg ms-2 run-another-app-btn">
                        <i class="fas fa-plus"></i> Run another application
                    </button>
                </div>
            </div>

            <div id="manualReviewMessage" class="status-message manual-review">
                <div class="icon">
                    <i class="fas fa-user-clock"></i>
                </div>
                <h3>Under Review 🔍</h3>
                <p>Your application requires additional review by our team.</p>
                <p>We'll notify you via email once our review is complete.</p>
                <p>This typically takes 1-2 business days.</p>
                <div class="mt-3">
                    <button type="button" class="btn btn-primary btn-lg" id="rerunLastAppBtn">
                        <i class="fas fa-redo"></i> Re-run Last App
                    </button>
                    <button type="button" class="btn btn-secondary btn-lg ms-2 run-another-app-btn">
                        <i class="fas fa-plus"></i> Run another application
                    </button>
                    <button type="button" class="btn btn-info btn-lg ms-2" id="reinitSDKBtn" style="display:none">
                        <i class="fas fa-sync-alt"></i> Re-verify Now
                    </button>
                </div>
            </div>

            <div id="pendingMessage" class="status-message pending">
                <div class="icon">
                    <i class="fas fa-spinner fa-spin"></i>
                </div>
                <h3>Verification in Progress ⏳</h3>
                <p>Please complete the additional verification steps.</p>
                <p>This will help us process your application.</p>
            </div>

            <div id="personForms">
                <div class="collapsible-entity expanded">
                    <div class="collapsible-header d-flex justify-content-between align-items-center">
                        <h3 class="mb-0">Person 1</h3>
                        <div>
                            <button type="button" class="btn btn-link btn-toggle-entity" data-target="#personFormCollapse-1" aria-expanded="true" aria-controls="personFormCollapse-1">
                                <i class="fas fa-chevron-down"></i>
                            </button>
                            <button type="button" class="btn btn-danger delete-person d-none">
                                <i class="fas fa-trash"></i> Delete Person
                            </button>
                        </div>
                    </div>
                    <div class="collapsible-body show" id="personFormCollapse-1">
                        <form class="person-form mb-4">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="name_first" class="form-label">First Name</label>
                                    <input type="text" class="form-control" name="name_first" required>
                                </div>
                                <div class="col-md-6">
                                    <label for="name_last" class="form-label">Last Name</label>
                                    <input type="text" class="form-control" name="name_last" required>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="email_address" class="form-label">Email</label>
                                <input type="email" class="form-control" name="email_address" required>
                            </div>
                            <div class="mb-3">
                                <label for="phone_number" class="form-label">Phone</label>
                                <input type="tel" class="form-control" name="phone_number" inputmode="numeric" pattern="^\\+?[1-9]\\d{1,14}$" placeholder="+1234567890" required oninput="this.value=this.value.replace(/[^0-9]/g,'')">
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="document_ssn" class="form-label">SSN</label>
                                    <input type="password" class="form-control ssn-input" name="document_ssn" maxlength="9" required oninput="this.value=this.value.replace(/[^0-9]/g,'')">
                                </div>
                                <div class="col-md-6">
                                    <label for="birth_date" class="form-label">Date of Birth</label>
                                    <input type="text" class="form-control" name="birth_date" required placeholder="YYYY-MM-DD" maxlength="10" autocomplete="off" inputmode="numeric" pattern="\d{4}-\d{2}-\d{2}">
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="ip_address" class="form-label">IP Address</label>
                                <input type="text" class="form-control" name="ip_address" pattern="^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$" placeholder="e.g. 192.168.1.1" required>
                                <div class="form-text">Enter a valid IPv4 address</div>
                            </div>
                            <div class="mb-3">
                                <label for="line_1" class="form-label">Street Address</label>
                                <input type="text" class="form-control" name="line_1" required>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-3">
                                    <label class="form-label">City</label>
                                    <input type="text" class="form-control" name="city" required>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">State/Province/Region</label>
                                    <input type="text" class="form-control" name="state">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">ZIP</label>
                                    <input type="text" class="form-control" name="postal_code" required>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Country</label>
                                    <select name="country_code" class="form-control" required>
                                      <option value="">Select Country</option>
                                      <option value="US">United States</option>
                                      <option value="CA">Canada</option>
                                      <option value="GB">United Kingdom</option>
                                      <option value="AU">Australia</option>
                                      <option value="DE">Germany</option>
                                      <option value="FR">France</option>
                                      <option value="IN">India</option>
                                      <option value="JP">Japan</option>
                                      <option value="CN">China</option>
                                      <option value="BR">Brazil</option>
                                      <option value="ZA">South Africa</option>
                                      <option value="MX">Mexico</option>
                                      <option value="RU">Russia</option>
                                      <option value="IT">Italy</option>
                                      <option value="ES">Spain</option>
                                      <option value="SG">Singapore</option>
                                      <option value="KR">South Korea</option>
                                      <option value="SE">Sweden</option>
                                      <option value="CH">Switzerland</option>
                                      <option value="NL">Netherlands</option>
                                      <option value="NZ">New Zealand</option>
                                      <option value="IE">Ireland</option>
                                      <option value="AR">Argentina</option>
                                      <option value="BE">Belgium</option>
                                      <option value="DK">Denmark</option>
                                      <option value="FI">Finland</option>
                                      <option value="NO">Norway</option>
                                      <option value="PL">Poland</option>
                                      <option value="PT">Portugal</option>
                                      <option value="TR">Turkey</option>
                                      <option value="UA">Ukraine</option>
                                      <option value="AE">United Arab Emirates</option>
                                      <option value="SA">Saudi Arabia</option>
                                      <option value="IL">Israel</option>
                                      <option value="TH">Thailand</option>
                                      <option value="MY">Malaysia</option>
                                      <option value="ID">Indonesia</option>
                                      <option value="PH">Philippines</option>
                                      <option value="EG">Egypt</option>
                                      <option value="NG">Nigeria</option>
                                      <option value="KE">Kenya</option>
                                      <option value="GH">Ghana</option>
                                      <option value="PK">Pakistan</option>
                                      <option value="BD">Bangladesh</option>
                                      <option value="VN">Vietnam</option>
                                      <option value="CO">Colombia</option>
                                      <option value="CL">Chile</option>
                                      <option value="PE">Peru</option>
                                      <option value="VE">Venezuela</option>
                                      <option value="CZ">Czech Republic</option>
                                      <option value="HU">Hungary</option>
                                      <option value="RO">Romania</option>
                                      <option value="GR">Greece</option>
                                      <option value="SK">Slovakia</option>
                                      <option value="BG">Bulgaria</option>
                                      <option value="HR">Croatia</option>
                                      <option value="SI">Slovenia</option>
                                      <option value="EE">Estonia</option>
                                      <option value="LT">Lithuania</option>
                                      <option value="LV">Latvia</option>
                                      <option value="LU">Luxembourg</option>
                                      <option value="MT">Malta</option>
                                      <option value="CY">Cyprus</option>
                                      <option value="IS">Iceland</option>
                                      <option value="MC">Monaco</option>
                                      <option value="LI">Liechtenstein</option>
                                      <option value="SM">San Marino</option>
                                      <option value="VA">Vatican City</option>
                                      <option value="QA">Qatar</option>
                                      <option value="KW">Kuwait</option>
                                      <option value="OM">Oman</option>
                                      <option value="BH">Bahrain</option>
                                      <option value="JO">Jordan</option>
                                      <option value="LB">Lebanon</option>
                                      <option value="IQ">Iraq</option>
                                      <option value="IR">Iran</option>
                                      <option value="AF">Afghanistan</option>
                                      <option value="LK">Sri Lanka</option>
                                      <option value="NP">Nepal</option>
                                      <option value="MM">Myanmar</option>
                                      <option value="KH">Cambodia</option>
                                      <option value="LA">Laos</option>
                                      <option value="MN">Mongolia</option>
                                      <option value="UZ">Uzbekistan</option>
                                      <option value="KZ">Kazakhstan</option>
                                      <option value="KG">Kyrgyzstan</option>
                                      <option value="TJ">Tajikistan</option>
                                      <option value="TM">Turkmenistan</option>
                                      <option value="AZ">Azerbaijan</option>
                                      <option value="GE">Georgia</option>
                                      <option value="AM">Armenia</option>
                                      <option value="MD">Moldova</option>
                                      <option value="BY">Belarus</option>
                                      <option value="RS">Serbia</option>
                                      <option value="ME">Montenegro</option>
                                      <option value="AL">Albania</option>
                                      <option value="MK">North Macedonia</option>
                                      <option value="BA">Bosnia and Herzegovina</option>
                                      <option value="ZW">Zimbabwe</option>
                                      <option value="ZM">Zambia</option>
                                      <option value="UG">Uganda</option>
                                      <option value="TZ">Tanzania</option>
                                      <option value="SD">Sudan</option>
                                      <option value="SS">South Sudan</option>
                                      <option value="ET">Ethiopia</option>
                                      <option value="DZ">Algeria</option>
                                      <option value="MA">Morocco</option>
                                      <option value="TN">Tunisia</option>
                                      <option value="LY">Libya</option>
                                      <option value="CM">Cameroon</option>
                                      <option value="CI">Ivory Coast</option>
                                      <option value="SN">Senegal</option>
                                      <option value="AO">Angola</option>
                                      <option value="MZ">Mozambique</option>
                                      <option value="BW">Botswana</option>
                                      <option value="NA">Namibia</option>
                                      <option value="MG">Madagascar</option>
                                      <option value="MW">Malawi</option>
                                      <option value="LS">Lesotho</option>
                                      <option value="SZ">Eswatini</option>
                                      <option value="GM">Gambia</option>
                                      <option value="SL">Sierra Leone</option>
                                      <option value="LR">Liberia</option>
                                      <option value="GA">Gabon</option>
                                      <option value="CG">Congo</option>
                                      <option value="CD">DR Congo</option>
                                      <option value="CF">Central African Republic</option>
                                      <option value="NE">Niger</option>
                                      <option value="ML">Mali</option>
                                      <option value="BF">Burkina Faso</option>
                                      <option value="TD">Chad</option>
                                      <option value="MR">Mauritania</option>
                                      <option value="SO">Somalia</option>
                                      <option value="DJ">Djibouti</option>
                                      <option value="ER">Eritrea</option>
                                      <option value="RW">Rwanda</option>
                                      <option value="BI">Burundi</option>
                                      <option value="SZ">Eswatini</option>
                                      <option value="SC">Seychelles</option>
                                      <option value="MU">Mauritius</option>
                                      <option value="KM">Comoros</option>
                                      <option value="ST">Sao Tome and Principe</option>
                                      <option value="CV">Cabo Verde</option>
                                      <option value="GQ">Equatorial Guinea</option>
                                      <option value="GW">Guinea-Bissau</option>
                                      <option value="GN">Guinea</option>
                                      <option value="BJ">Benin</option>
                                      <option value="TG">Togo</option>
                                      <option value="RE">Reunion</option>
                                      <option value="YT">Mayotte</option>
                                      <option value="PM">Saint Pierre and Miquelon</option>
                                      <option value="GL">Greenland</option>
                                      <option value="FO">Faroe Islands</option>
                                      <option value="GI">Gibraltar</option>
                                      <option value="JE">Jersey</option>
                                      <option value="GG">Guernsey</option>
                                      <option value="IM">Isle of Man</option>
                                      <option value="AX">Aland Islands</option>
                                      <option value="BQ">Caribbean Netherlands</option>
                                      <option value="CW">Curacao</option>
                                      <option value="SX">Sint Maarten</option>
                                      <option value="BL">Saint Barthelemy</option>
                                      <option value="MF">Saint Martin</option>
                                      <option value="GP">Guadeloupe</option>
                                      <option value="MQ">Martinique</option>
                                      <option value="GF">French Guiana</option>
                                      <option value="PF">French Polynesia</option>
                                      <option value="NC">New Caledonia</option>
                                      <option value="WF">Wallis and Futuna</option>
                                      <option value="TF">French Southern Territories</option>
                                      <option value="BV">Bouvet Island</option>
                                      <option value="HM">Heard Island and McDonald Islands</option>
                                      <option value="GS">South Georgia and the South Sandwich Islands</option>
                                      <option value="AQ">Antarctica</option>
                                    </select>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="meta" class="form-label">Meta Data (JSON)</label>
                                <textarea class="form-control" name="meta" rows="3" placeholder='{"key": "value"}'></textarea>
                                <div class="invalid-feedback">Please enter valid JSON</div>
                                <div class="json-help text-danger" style="display:none;">Invalid JSON. Please enter a valid JSON object, e.g. {"key": "value"}</div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <div class="mb-4 action-row-right" id="actionRow">
                <button type="submit" class="btn btn-primary" id="submitBtn">
                    <i class="fas fa-paper-plane"></i> Submit Application
                </button>
            </div>
        </div>
        <div id="devSection" class="dev-section">
            <h2 class="mb-4"><i class="fas fa-code form-icon"></i>Developer Mode</h2>
            <div class="collapsible-entity">
                <div class="collapsible-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Request</h5>
                    <button type="button" class="btn btn-link btn-toggle-entity" data-target="#requestViewCollapse" aria-expanded="false" aria-controls="requestViewCollapse">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
                <div class="collapsible-body" id="requestViewCollapse">
                    <pre id="requestView"></pre>
                </div>
            </div>
            <div class="collapsible-entity">
                <div class="collapsible-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Response</h5>
                    <button type="button" class="btn btn-link btn-toggle-entity" data-target="#responseViewCollapse" aria-expanded="false" aria-controls="responseViewCollapse">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
                <div class="collapsible-body" id="responseViewCollapse">
                    <pre id="responseView"></pre>
                </div>
            </div>
        </div>
    </div>

    <!-- SDK Container -->
    <div id="alloySDKContainer">
        <div class="modal-wrapper">
            <div id="alloySDKMount"></div>
            <button id="closeSDK">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notificationContainer" class="notification-container"></div>

    <!-- Floating Dashboard Links Button -->
    <button id="dashboardLinksFab" class="fab-dashboard-links" aria-label="Recent Application Links" type="button">
        <i class="fa-solid fa-clipboard-list"></i>
    </button>
    <div id="dashboardLinksPopover" class="fab-popover" tabindex="-1" aria-label="Recent Application Links" style="display: none; width: 620px; min-width: 620px; max-width: 620px;">
        <div class="fab-popover-header d-flex justify-content-between align-items-center">
            <span><i class="fas fa-external-link-alt me-2"></i>Recent Application Links</span>
            <button id="closeFabPopover" class="btn btn-sm btn-link p-0" aria-label="Close"><i class="fas fa-times"></i></button>
        </div>
        <div id="fabFilterControls" class="mb-2" style="padding: 0 0.5rem;">
          <input type="text" id="fabSearchInput" class="form-control form-control-sm mb-2" placeholder="Search by business or person...">
          <select id="fabStatusFilter" class="form-select form-select-sm">
            <option value="">All Statuses</option>
            <option value="Approved">Approved</option>
            <option value="Denied">Denied</option>
            <option value="Manual Review">Manual Review</option>
            <option value="Pending">Pending</option>
          </select>
        </div>
        <ul id="fabLinksList" class="list-group list-group-flush mb-0"></ul>
    </div>

    <!-- Custom Profile Modal (reuse Persons form) -->
    <div id="customProfileModal" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="max-width: 1200px; width: 100%;">
            <div class="modal-header">
                <h4 class="modal-title" id="customProfileModalTitle">Add Custom Profile</h4>
            </div>
            <div class="modal-body" id="customProfileModalBody">
                <!-- The person form will be cloned and inserted here dynamically -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary me-2" id="cancelCustomProfile">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveCustomProfile">Save</button>
            </div>
        </div>
    </div>

    <!-- In-app confirmation modal (reusable) -->
    <div id="inAppConfirmModal" class="modal-overlay" style="display: none;">
      <div class="modal-content" style="max-width: 400px;">
        <div class="modal-header">
          <h4 class="modal-title" id="inAppConfirmTitle">Confirm</h4>
        </div>
        <div class="modal-body">
          <p id="inAppConfirmMessage">Are you sure?</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary me-2" id="inAppConfirmCancel">Cancel</button>
          <button type="button" class="btn btn-danger" id="inAppConfirmOk">OK</button>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // --- GLOBAL PATCH: Debug window.alloy.open usage ---
        (function() {
            const alloyOpenPatch = () => {
                if (window.alloy && typeof window.alloy.open === 'function' && !window.alloy._openPatched) {
                    const originalAlloyOpen = window.alloy.open;
                    window.alloy.open = function(...args) {
                        console.log('window.alloy.open CALLED', args);
                        if (typeof args[0] === 'function') {
                            const userCallback = args[0];
                            args[0] = function(data) {
                                console.log('window.alloy.open CALLBACK', data);
                                return userCallback(data);
                            };
                        }
                        return originalAlloyOpen.apply(this, args);
                    };
                    window.alloy._openPatched = true;
                }
            };
            // Patch immediately if alloy is already loaded
            if (window.alloy) {
                alloyOpenPatch();
            }
            // Also patch after DOMContentLoaded in case alloy loads later
            document.addEventListener('DOMContentLoaded', () => {
                setTimeout(alloyOpenPatch, 500);
            });
            // And patch again after 2 seconds in case alloy loads even later
            setTimeout(alloyOpenPatch, 2000);
        })();
        // ... existing code ...

        // Initialize Alloy SDK config
        let alloyConfig = {
            key: '',
            journeyApplicationToken: 'JA-xyz',
            journeyToken: ''
        };

        // Function to load Alloy SDK
        function loadAlloySDK() {
            return new Promise((resolve, reject) => {
                if (typeof window.Alloy !== 'undefined') {
                    resolve();
                    return;
                }
                const script = document.createElement('script');
                script.src = 'https://scripts.alloy.com/2/2/alloy_sdk_bundle.js';
                script.async = true;
                script.onload = () => {
                    const checkAlloy = () => {
                        if (typeof window.Alloy !== 'undefined') {
                            resolve();
                        } else if (typeof window.alloy !== 'undefined') {
                            window.Alloy = window.alloy;
                            resolve();
                        } else {
                            setTimeout(checkAlloy, 500);
                        }
                    };
                    checkAlloy();
                };
                script.onerror = (error) => {
                    reject(new Error('Failed to load Alloy SDK script'));
                };
                document.head.appendChild(script);
            });
        }

        // Fetch configuration from server
        async function initializeAlloy() {
            try {
                const response = await fetch('/api/config');
                if (!response.ok) {
                    throw new Error(`Failed to fetch config: ${response.status} ${response.statusText}`);
                }
                const config = await response.json();
                if (!config.ALLOY_SDK_KEY || !config.ALLOY_JOURNEY_TOKEN || !config.ALLOY_TOKEN || !config.ALLOY_SECRET || !config.ALLOY_BASE_URL) {
                    window.location.href = '/config.html';
                    return;
                }
                alloyConfig = {
                    key: config.ALLOY_SDK_KEY,
                    journeyToken: config.ALLOY_JOURNEY_TOKEN,
                    token: config.ALLOY_TOKEN,
                    secret: config.ALLOY_SECRET,
                    baseUrl: config.ALLOY_BASE_URL
                };
                // console.log('Alloy configuration loaded successfully', alloyConfig);
            } catch (error) {
                console.error('Error initializing Alloy:', error);
                alert('Failed to initialize verification system. Please try again later.');
                throw error;
            }
        }

        // Function to initialize Alloy SDK for step-up
        async function initializeAlloySDK(journeyApplicationToken) {
            const sdkContainer = document.getElementById('alloySDKContainer');
            const sdkMount = document.getElementById('alloySDKMount');
            sdkContainer.style.display = 'block';
            try {
                const credentials = btoa(`${alloyConfig.token}:${alloyConfig.secret}`);
                await window.alloy.init({
                    key: alloyConfig.key,
                    journeyToken: alloyConfig.journeyToken,
                    journeyApplicationToken: journeyApplicationToken,
                    production: false,
                    headers: {
                        'Authorization': `Basic ${credentials}`
                    }
                });
                window.alloy.open((data) => {
                    sdkContainer.style.display = 'none';
                    if (!window.applicationLinks) window.applicationLinks = [];

                    console.log('SDK callback triggered', data);
                    let jaToken = data?.journey_application_token || '';
                    let idx = -1;
                    if (jaToken) {
                        idx = window.applicationLinks.findIndex(app => app.jaToken === jaToken);
                    }
                    console.log('jaToken:', jaToken, 'idx:', idx);
                    if (idx === -1 && jaToken) {
                        // Build dashboardUrl as in the submission handler
                        const jToken = (typeof alloyConfig !== 'undefined' && alloyConfig.journeyToken) ? alloyConfig.journeyToken : '';
                        const baseUrl = (typeof alloyConfig !== 'undefined' && alloyConfig.baseUrl) ? alloyConfig.baseUrl : '';
                        let dashboardUrl = '';
                        if (baseUrl.includes('api.alloy.co') || baseUrl.includes('sandbox.alloy.co')) {
                            dashboardUrl = `https://app.alloy.co/v3/dashboard/journeys/${jToken}/applications/${jaToken}`;
                        } else if (baseUrl) {
                            const match = baseUrl.match(/^https:\/\/([^\.]+)/);
                            const client = match ? match[1] : 'client';
                            dashboardUrl = `https://${client}.app.alloy.com/v3/dashboard/journeys/${jToken}/applications/${jaToken}`;
                        }
                        // Use lastSubmittedData for data/person1 if available
                        let person1 = { first: '', last: '' };
                        let appData = {};
                        if (typeof lastSubmittedData !== 'undefined' && lastSubmittedData && lastSubmittedData.entities) {
                            appData = JSON.parse(JSON.stringify(lastSubmittedData));
                            try {
                                const p1 = lastSubmittedData.entities.find(e => e.entity_type === 'person');
                                if (p1 && p1.data) {
                                    person1.first = p1.data.name_first || '';
                                    person1.last = p1.data.name_last || '';
                                }
                            } catch {}
                        }
                        console.log('Adding to applicationLinks:', { jaToken, dashboardUrl, appData, person1, status: data?.journey_application_status || data?.status });
                        window.applicationLinks.unshift({
                            jaToken,
                            url: dashboardUrl,
                            data: appData,
                            submittedAt: new Date().toISOString(),
                            person1,
                            status: data?.journey_application_status || data?.status || 'pending_step_up'
                        });
                        console.log('applicationLinks after push:', window.applicationLinks);
                        if (window.api && window.api.saveApplicationHistory) {
                            window.api.saveApplicationHistory(window.applicationLinks);
                            console.log('Saved applicationLinks to history');
                        }
                    } else if (idx > -1) {
                        // Update status and any other fields
                        window.applicationLinks[idx].status = data.journey_application_status || data.status || window.applicationLinks[idx].status;
                        if (window.api && window.api.saveApplicationHistory) {
                            window.api.saveApplicationHistory(window.applicationLinks);
                        }
                    }
                    // DEBUG LOG: End of alloy.open callback
                    console.log('End of alloy.open callback', { applicationLinks: window.applicationLinks, data, lastSubmittedData });

                    // Show Under Review if closed without completion
                    if (!data || data.status === 'pending_step_up') {
                        if (typeof showStatusMessage === 'function') showStatusMessage('manualReviewMessage');
                        if (typeof hideProcessingModal === 'function') hideProcessingModal();
                        renderFabLinks();
                        return;
                    }
                    if (data.journey_application_status) {
                        if (data.status === 'completed') {
                            if (data.journey_application_status === 'Approved') {
                                if (typeof showStatusMessage === 'function') showStatusMessage('approvedMessage');
                            } else if (data.journey_application_status === 'Denied') {
                                if (typeof showStatusMessage === 'function') showStatusMessage('deniedMessage');
                            } else if (data.journey_application_status === 'Pending') {
                                if (typeof showStatusMessage === 'function') showStatusMessage('manualReviewMessage');
                            } else {
                                if (typeof showStatusMessage === 'function') showStatusMessage('manualReviewMessage');
                            }
                        }
                    }
                    renderFabLinks(); // Now the FAB will show the latest status
                }, 'alloySDKMount');
            } catch (error) {
                console.error('Error initializing Alloy SDK:', error);
                sdkContainer.style.display = 'none';
            }
        }

        // Call initialization on page load
        document.addEventListener('DOMContentLoaded', () => {
            initializeAlloy().catch(error => {
                console.error('Initialization failed:', error);
            });
        });

        // Function to show a specific status message
        function showStatusMessage(messageId) {
            // Hide all status messages first
            document.querySelectorAll('.status-message').forEach(msg => msg.style.display = 'none');
            // Show the specified message
            document.getElementById(messageId).style.display = 'block';
            // Special logic for manualReviewMessage
            if (messageId === 'manualReviewMessage') {
                const btn = document.getElementById('reinitSDKBtn');
                const msgDiv = document.getElementById('manualReviewMessage');
                if (sdkStepUpAvailable && lastJourneyApplicationToken) {
                    // SDK was closed without completion, show pending doc verification message
                    msgDiv.querySelector('h3').textContent = 'Pending Document Verification';
                    const ps = msgDiv.querySelectorAll('p');
                    if (ps.length >= 3) {
                        ps[0].textContent = 'Your application requires additional information to be processed.';
                        ps[1].textContent = 'Please click "Re-verify Now" below to complete your application.';
                        // Hide the other <p> tags if present
                        for (let i = 2; i < ps.length; i++) ps[i].style.display = 'none';
                    }
                    if (btn) btn.style.display = '';
                } else {
                    // Actual manual review, show original message
                    msgDiv.querySelector('h3').textContent = 'Under Review 🔍';
                    const ps = msgDiv.querySelectorAll('p');
                    if (ps.length >= 3) {
                        ps[0].textContent = 'Your application requires additional review by our team.';
                        ps[1].textContent = "We'll notify you via email once our review is complete.";
                        ps[2].textContent = 'This typically takes 1-2 business days.';
                        for (let i = 0; i < ps.length; i++) ps[i].style.display = '';
                    }
                    if (btn) btn.style.display = 'none';
                }
            }
        }

        // Function to initialize Alloy SDK for step-up
        async function initializeAlloySDK(journeyApplicationToken) {
            const sdkContainer = document.getElementById('alloySDKContainer');
            const sdkMount = document.getElementById('alloySDKMount');
            
            sdkContainer.style.display = 'block';
            
            try {
                // Debug alloy object
                // console.log('Alloy Object:', {
                //     type: typeof window.alloy,
                //     methods: Object.keys(window.alloy || {}),
                //     init: typeof window.alloy?.init,
                //     open: typeof window.alloy?.open
                // });

                // Create base64 encoded credentials
                const credentials = btoa(`${alloyConfig.token}:${alloyConfig.secret}`);

                // console.log('Initializing Alloy SDK with config:', {
                //     key: alloyConfig.key,
                //     journeyToken: alloyConfig.journeyToken,
                //     journeyApplicationToken: journeyApplicationToken,
                //     production: false
                // });

                // Initialize Alloy with the configuration
                await window.alloy.init({
                    key: alloyConfig.key,
                    journeyToken: alloyConfig.journeyToken,
                    journeyApplicationToken: journeyApplicationToken,
                    production: false,
                    headers: {
                        'Authorization': `Basic ${credentials}`
                    }
                });

                // console.log('Alloy SDK initialized successfully');

                // Open the SDK with callback and parent component
                // console.log('Opening Alloy SDK...');
                window.alloy.open((data) => {
                    // console.log('SDK Callback Data:', data);
                    
                    // Handle SDK closure
                    if (!data || data.status === 'pending_step_up') {
                        // SDK was closed without completion
                        sdkStepUpAvailable = true;
                        lastJourneyApplicationToken = journeyApplicationToken;
                        showStatusMessage('manualReviewMessage');
                        hideProcessingModal();
                        sdkContainer.style.display = 'none';
                        return;
                    }

                    if (data.journey_application_status) {
                        // console.log('Journey Application Status:', data.journey_application_status);
                        // Update UI based on SDK completion
                        if (data.status === 'completed') {
                            // Parse the application status
                            let applicationStatus;
                            if (data.journey_application_status === 'Approved') {
                                applicationStatus = 'Approved';
                                showStatusMessage('approvedMessage');
                            } else if (data.journey_application_status === 'Denied') {
                                applicationStatus = 'Denied';
                                showStatusMessage('deniedMessage');
                            } else if (data.journey_application_status === 'Pending') {
                                applicationStatus = 'Manual Review';
                                showStatusMessage('manualReviewMessage');
                            } else {
                                applicationStatus = data.journey_application_status || 'Unknown';
                                showStatusMessage('manualReviewMessage');
                            }
                        }
                    }
                    sdkContainer.style.display = 'none';
                }, 'alloySDKMount');

                // Add a timeout to check if the SDK mounted
                setTimeout(() => {
                    // console.log('SDK Mount Check:', {
                    //     hasChildren: sdkMount?.children?.length > 0,
                    //     innerHTML: sdkMount?.innerHTML,
                    //     computedStyle: window.getComputedStyle(sdkMount),
                    //     alloyMethods: Object.keys(window.alloy || {}),
                    //     sdkMountDisplay: sdkMount.style.display,
                    //     sdkContainerDisplay: sdkContainer.style.display,
                    //     sdkMountDimensions: {
                    //         width: sdkMount.offsetWidth,
                    //         height: sdkMount.offsetHeight,
                    //         clientWidth: sdkMount.clientWidth,
                    //         clientHeight: sdkMount.clientHeight
                    //     }
                    // });
                }, 2000);

            } catch (error) {
                console.error('Error initializing Alloy SDK:', error);
                console.error('Error details:', {
                    message: error.message,
                    stack: error.stack,
                    alloyAvailable: typeof window.alloy !== 'undefined',
                    config: {
                        hasKey: !!alloyConfig.key,
                        hasJourneyToken: !!alloyConfig.journeyToken,
                        hasJourneyApplicationToken: !!journeyApplicationToken
                    }
                });
                alert('Failed to initialize verification. Please try again.');
                sdkContainer.style.display = 'none';
                showStatusMessage('manualReviewMessage');
            }
        }

        // Close button handler
        document.getElementById('closeSDK').addEventListener('click', () => {
            const sdkContainer = document.getElementById('alloySDKContainer');
            sdkContainer.style.display = 'none';
            // Show manual review message when SDK is closed prematurely
            showStatusMessage('manualReviewMessage');
            // Hide the processing modal if it's showing
            hideProcessingModal();
        });

        // Sandbox Profiles Configuration
        const sandboxProfiles = [
            {
                category: 'Document Verification',
                profiles: [
                    {
                        name: 'OnfidoMR',
                        field: 'name_last',
                        value: 'OnfidoMR',
                        description: 'Sets last name to "OnfidoMR" to trigger Manual Review with Onfido'
                    },
                    {
                        name: 'ForceOnfido',
                        field: 'name_last',
                        value: 'ForceOnfido',
                        description: 'Sets last name to "ForceOnfido" to force Onfido verification'
                    },
                    {
                        name: 'ForceVouched',
                        field: 'name_last',
                        value: 'ForceVouched',
                        description: 'Sets last name to "ForceVouched" to force Vouched verification'
                    },
                    {
                        name: 'ForceManualReview',
                        field: 'name_last',
                        value: 'ForceManualReview',
                        description: 'Sets last name to "ForceManualReview" to force Manual Review Outcome'
                    }
                ]
            },
            {
                category: 'SSN Testing',
                profiles: [
                    {
                        name: 'SSN 111-11-1111',
                        field: 'document_ssn',
                        value: '111111111',
                        description: 'Sets SSN to 111-11-1111'
                    },
                    {
                        name: 'SSN 222-22-2222',
                        field: 'document_ssn',
                        value: '222222222',
                        description: 'Sets SSN to 222-22-2222'
                    },
                    {
                        name: 'SSN 333-33-3333',
                        field: 'document_ssn',
                        value: '333333333',
                        description: 'Sets SSN to 333-33-3333'
                    },
                    {
                        name: 'SSN 444-44-4444',
                        field: 'document_ssn',
                        value: '444444444',
                        description: 'Sets SSN to 444-44-4444'
                    },
                    {
                        name: 'SSN 555-55-5555',
                        field: 'document_ssn',
                        value: '555555555',
                        description: 'Sets SSN to 555-55-5555'
                    },
                    {
                        name: 'SSN 666-66-6666',
                        field: 'document_ssn',
                        value: '666666666',
                        description: 'Sets SSN to 666-66-6666'
                    },
                    {
                        name: 'SSN 777-77-7777',
                        field: 'document_ssn',
                        value: '777777777',
                        description: 'Sets SSN to 777-77-7777'
                    },
                    {
                        name: 'SSN 888-88-8888',
                        field: 'document_ssn',
                        value: '888888888',
                        description: 'Sets SSN to 888-88-8888'
                    },
                    {
                        name: 'SSN 999-99-9999',
                        field: 'document_ssn',
                        value: '999999999',
                        description: 'Sets SSN to 999-99-9999'
                    }
                ]
            },
            {
                category: 'ZIP Code Testing',
                profiles: [
                    {
                        name: 'ZIP 00000',
                        field: 'postal_code',
                        value: '00000',
                        description: 'Sets ZIP code to 00000'
                    },
                    {
                        name: 'ZIP 11111',
                        field: 'postal_code',
                        value: '11111',
                        description: 'Sets ZIP code to 11111'
                    },
                    {
                        name: 'ZIP 22222',
                        field: 'postal_code',
                        value: '22222',
                        description: 'Sets ZIP code to 22222'
                    },
                    {
                        name: 'ZIP 33333',
                        field: 'postal_code',
                        value: '33333',
                        description: 'Sets ZIP code to 33333'
                    },
                    {
                        name: 'ZIP 44444',
                        field: 'postal_code',
                        value: '44444',
                        description: 'Sets ZIP code to 44444'
                    },
                    {
                        name: 'ZIP 55555',
                        field: 'postal_code',
                        value: '55555',
                        description: 'Sets ZIP code to 55555'
                    },
                    {
                        name: 'ZIP 66666',
                        field: 'postal_code',
                        value: '66666',
                        description: 'Sets ZIP code to 66666'
                    },
                    {
                        name: 'ZIP 77777',
                        field: 'postal_code',
                        value: '77777',
                        description: 'Sets ZIP code to 77777'
                    },
                    {
                        name: 'ZIP 88888',
                        field: 'postal_code',
                        value: '88888',
                        description: 'Sets ZIP code to 88888'
                    },
                    {
                        name: 'ZIP 99999',
                        field: 'postal_code',
                        value: '99999',
                        description: 'Sets ZIP code to 99999'
                    }
                ]
            }
        ];

        // Function to populate profile list
        function populateProfileList(searchTerm = '') {
            const profileList = document.getElementById('profileList');
            profileList.innerHTML = '';
            
            sandboxProfiles.forEach(category => {
                const filteredProfiles = category.profiles.filter(profile => 
                    profile.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    profile.description.toLowerCase().includes(searchTerm.toLowerCase())
                );

                if (filteredProfiles.length > 0) {
                    // Add category header
                    const categoryHeader = document.createElement('h6');
                    categoryHeader.className = 'dropdown-header text-primary mb-2';
                    categoryHeader.innerHTML = `<i class="fas fa-folder-open me-2"></i>${category.category}`;
                    profileList.appendChild(categoryHeader);

                    // Add profiles in this category
                    filteredProfiles.forEach(profile => {
                        const item = document.createElement('div');
                        item.className = 'dropdown-item mb-2';
                        item.style.cursor = 'pointer';
                        item.innerHTML = `
                            <div class="d-flex flex-column">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-vial me-2"></i>
                                    <strong>${profile.name}</strong>
                                </div>
                                <small class="text-muted ms-4">${profile.description}</small>
                            </div>
                        `;
                        item.addEventListener('click', (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            applySandboxProfile(profile);
                        });
                        profileList.appendChild(item);
                    });

                    // Add divider after each category
                    const divider = document.createElement('div');
                    divider.className = 'dropdown-divider mb-2';
                    profileList.appendChild(divider);
                }
            });
        }

        // Function to show profile indicator with transition
        function showProfileIndicator(profile) {
            const profileIndicator = document.getElementById('profileIndicator');
            const profileName = document.getElementById('profileName');
            const profileDescription = document.getElementById('profileDescription');
            
            profileName.textContent = profile.name;
            profileDescription.textContent = profile.description;
            profileIndicator.classList.remove('d-none');
        }

        // Function to hide profile indicator with transition
        function hideProfileIndicator() {
            const profileIndicator = document.getElementById('profileIndicator');
            profileIndicator.classList.add('d-none');
        }

        // Function to apply sandbox profile
        function applySandboxProfile(profile) {
            try {
                // Show modal to select persons
                const personForms = document.querySelectorAll('.person-form');
                const modal = document.getElementById('sandboxProfileModal');
                const personList = document.getElementById('sandboxProfilePersonList');
                personList.innerHTML = '';
                // Add ALL option
                const allId = 'sandboxProfileAll';
                const allDiv = document.createElement('div');
                allDiv.className = 'form-check mb-2';
                allDiv.innerHTML = `<input class="form-check-input" type="checkbox" id="${allId}"><label class="form-check-label" for="${allId}"><strong>ALL</strong></label>`;
                personList.appendChild(allDiv);
                // Add each person
                personForms.forEach((form, idx) => {
                    const id = `sandboxProfilePerson${idx}`;
                    const div = document.createElement('div');
                    div.className = 'form-check mb-2';
                    div.innerHTML = `<input class="form-check-input" type="checkbox" id="${id}" data-idx="${idx}"><label class="form-check-label" for="${id}">Person ${idx + 1}</label>`;
                    personList.appendChild(div);
                });
                // ALL checkbox logic
                const allCheckbox = document.getElementById(allId);
                allCheckbox.addEventListener('change', function() {
                    personList.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                        if (cb !== allCheckbox) cb.checked = allCheckbox.checked;
                    });
                });
                // If all persons are checked, check ALL
                personList.addEventListener('change', function() {
                    const checkboxes = Array.from(personList.querySelectorAll('input[type="checkbox"]')).filter(cb => cb !== allCheckbox);
                    allCheckbox.checked = checkboxes.every(cb => cb.checked);
                });
                // Show modal
                modal.style.display = 'flex';
                // If there's only one person, automatically check their box
                if (personForms.length === 1) {
                    const singlePersonCheckbox = document.getElementById('sandboxProfilePerson0');
                    if (singlePersonCheckbox) {
                        singlePersonCheckbox.checked = true;
                    }
                }
                // Cancel button
                document.getElementById('cancelSandboxProfile').onclick = () => {
                    modal.style.display = 'none';
                };
                // Confirm button
                document.getElementById('confirmSandboxProfile').onclick = () => {
                    // Get selected persons
                    const selected = [];
                    personList.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                        if (cb !== allCheckbox && cb.checked) selected.push(parseInt(cb.getAttribute('data-idx')));
                    });
                    // Apply profile only to selected persons
                    personForms.forEach((form, idx) => {
                        if (selected.includes(idx)) {
                            // Fill with Faker data first
                            generateUniqueDummyData(form);
                            // Clear validation errors for all fields in this form
                            form.querySelectorAll('input, select, textarea').forEach(field => {
                                // Remove all .invalid-feedback elements in the same parent
                                const parent = field.parentNode;
                                parent.querySelectorAll('.invalid-feedback').forEach(err => err.remove());
                                // Forcefully remove is-invalid and aria-invalid
                                field.classList.remove('is-invalid');
                                field.removeAttribute('aria-invalid');
                                if (typeof field.setCustomValidity === 'function') {
                                    field.setCustomValidity('');
                                }
                            });
                            // Then apply the profile value
                            const field = form.querySelector(`[name="${profile.field}"]`);
                            if (field) {
                                field.value = profile.value;
                                field.setAttribute('data-sandbox-profile', 'true');
                                // If this is a country field, trigger the change event
                                if (profile.field === 'country_code') {
                                    field.dispatchEvent(new Event('change'));
                                }
                            }
                        }
                    });
                    modal.style.display = 'none';
                    // Only show profile indicator if at least one person was selected
                    if (selected.length > 0) {
                        showProfileIndicator(profile);
                    }
                    // Optional: Scroll to the submit button to draw attention to it
                    const submitButton = document.querySelector('button[type="submit"]');
                    if (submitButton) {
                        submitButton.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                };
            } catch (error) {
                console.error('Error applying sandbox profile:', error);
            }
        }

        // Function to generate sample data
        function generateSampleData() {
            try {
                if (typeof window.fakerUtils === 'undefined') {
                    console.error('Faker utils are not available');
                    return;
                }
                
                const forms = document.querySelectorAll('.person-form');
                forms.forEach(form => {
                    const data = window.fakerUtils.generateSampleData();
                    
                    form.querySelectorAll('input, select, textarea').forEach(field => {
                        // Remove all .invalid-feedback elements in the same parent
                        const parent = field.parentNode;
                        parent.querySelectorAll('.invalid-feedback').forEach(err => err.remove());
                        // Forcefully remove is-invalid and aria-invalid
                        field.classList.remove('is-invalid');
                        field.removeAttribute('aria-invalid');
                        if (typeof field.setCustomValidity === 'function') {
                            field.setCustomValidity('');
                        }
                    });
                    
                    // Fill the form with the generated data, but only if the field is empty and not set by a Sandbox Profile
                    const nameFirstInput = form.querySelector('[name="name_first"]');
                    const nameLastInput = form.querySelector('[name="name_last"]');
                    const emailInput = form.querySelector('[name="email_address"]');
                    const phoneInput = form.querySelector('[name="phone_number"]');
                    const ssnInput = form.querySelector('[name="document_ssn"]');
                    const birthDateInput = form.querySelector('[name="birth_date"]');
                    const ipAddressInput = form.querySelector('[name="ip_address"]');
                    const line1Input = form.querySelector('[name="line_1"]');
                    const cityInput = form.querySelector('[name="city"]');
                    const stateInput = form.querySelector('[name="state"]');
                    const postalCodeInput = form.querySelector('[name="postal_code"]');

                    if (nameFirstInput && !nameFirstInput.value && !nameFirstInput.hasAttribute('data-sandbox-profile')) nameFirstInput.value = data.firstName;
                    if (nameLastInput && !nameLastInput.value && !nameLastInput.hasAttribute('data-sandbox-profile')) nameLastInput.value = data.lastName;
                    if (emailInput && !emailInput.value && !emailInput.hasAttribute('data-sandbox-profile')) emailInput.value = data.email;
                    if (phoneInput && !phoneInput.value && !phoneInput.hasAttribute('data-sandbox-profile')) phoneInput.value = data.phone;
                    if (ssnInput && !ssnInput.value && !ssnInput.hasAttribute('data-sandbox-profile')) ssnInput.value = data.ssn;
                    if (birthDateInput && !birthDateInput.value && !birthDateInput.hasAttribute('data-sandbox-profile')) birthDateInput.value = data.birthDate;
                    if (ipAddressInput && !ipAddressInput.value && !ipAddressInput.hasAttribute('data-sandbox-profile')) ipAddressInput.value = data.ipAddress;
                    if (line1Input && !line1Input.value && !line1Input.hasAttribute('data-sandbox-profile')) line1Input.value = data.streetAddress;
                    if (cityInput && !cityInput.value && !cityInput.hasAttribute('data-sandbox-profile')) cityInput.value = data.city;
                    if (stateInput && !stateInput.value && !stateInput.hasAttribute('data-sandbox-profile')) stateInput.value = data.state;
                    if (postalCodeInput && !postalCodeInput.value && !postalCodeInput.hasAttribute('data-sandbox-profile')) postalCodeInput.value = data.zipCode;

                    // In generateSampleData and generateUniqueDummyData, after filling address fields:
                    const countrySelect = form.querySelector('select[name="country_code"]');
                    if (countrySelect) {
                        countrySelect.value = 'US';
                        countrySelect.dispatchEvent(new Event('change'));
                    }
                });

                // Hide profile indicator with transition
                hideProfileIndicator();
            } catch (error) {
                console.error('Error generating sample data:', error);
            }
        }

        // Initialize profile list and search functionality
        document.addEventListener('DOMContentLoaded', () => {
            // Wait a bit to ensure the bundle is loaded
            setTimeout(() => {
                try {
                    if (typeof window.fakerUtils === 'undefined' || typeof window.fakerUtils.generateSampleData !== 'function') {
                        console.error('Faker utils are not properly initialized');
                        return;
                    }

                    console.log('Faker utils successfully loaded');
                    populateProfileList();
                    
                    const searchInput = document.getElementById('profileSearch');
                    searchInput.addEventListener('input', (e) => {
                        populateProfileList(e.target.value);
                    });
                    
                    // Prevent dropdown from closing when clicking inside
                    document.querySelector('.dropdown-menu').addEventListener('click', (e) => {
                        e.stopPropagation();
                    });
                    
                    // Update the existing prefillBtn click handler
                    document.getElementById('prefillBtn').onclick = generateSampleData;
                } catch (error) {
                    console.error('Error initializing UI:', error);
                }
            }, 500); // Give the script a moment to load
        });



        function hideProcessingModal() {
            document.getElementById('processingModal').style.display = 'none';
        }

        // Ensure modal stays visible for at least 1 second
        async function withMinimumLoadingTime(promise) {
            const start = Date.now();
            const MINIMUM_LOADING_TIME = 1000; // 1 second

            try {
                const result = await promise;
                const elapsed = Date.now() - start;
                if (elapsed < MINIMUM_LOADING_TIME) {
                    await new Promise(resolve => setTimeout(resolve, MINIMUM_LOADING_TIME - elapsed));
                }
                return result;
            } catch (error) {
                const elapsed = Date.now() - start;
                if (elapsed < MINIMUM_LOADING_TIME) {
                    await new Promise(resolve => setTimeout(resolve, MINIMUM_LOADING_TIME - elapsed));
                }
                throw error;
            }
        }

        // Update dropdown styles
        document.addEventListener('DOMContentLoaded', () => {
            const dropdownMenu = document.querySelector('.dropdown-menu');
            if (dropdownMenu) {
                dropdownMenu.style.minWidth = '400px';
                dropdownMenu.style.padding = '1rem';
            }
        });

        // Delete confirmation modal handlers
        let templateToDelete = null;
        let deletePersonKeyListener = null;

        document.getElementById('cancelDelete').addEventListener('click', function() {
            const modal = document.getElementById('deletePersonModal');
            modal.style.display = 'none';
            templateToDelete = null;
            if (deletePersonKeyListener) {
                document.removeEventListener('keydown', deletePersonKeyListener);
                deletePersonKeyListener = null;
            }
        });

        document.getElementById('confirmDelete').addEventListener('click', function() {
            if (templateToDelete) {
                templateToDelete.remove();
                // Check if this was the last representative
                const representativeFormsContainer = document.getElementById('representativeForms');
                const remainingRepresentatives = representativeFormsContainer.querySelectorAll('.collapsible-entity').length;
                if (remainingRepresentatives === 0) {
                    // Hide the container and adjust margins
                    representativeFormsContainer.style.display = 'none';
                    const addRepContainer = document.getElementById('addRepresentativeContainer');
                    if (addRepContainer) addRepContainer.style.marginBottom = '0';
                }
                templateToDelete = null;
            }
            const modal = document.getElementById('deletePersonModal');
            modal.style.display = 'none';
        });

        // When delete button is clicked, set templateToDelete
        function setDeleteTemplate(template) {
            templateToDelete = template;
            // Attach keydown listener only when modal is open
            if (!deletePersonKeyListener) {
                deletePersonKeyListener = function(e) {
                    const deletePersonModal = document.getElementById('deletePersonModal');
                    if (deletePersonModal.style.display === 'flex') {
                        if (e.key === 'Enter') {
                            document.getElementById('confirmDelete').click();
                        } else if (e.key === 'Escape') {
                            document.getElementById('cancelDelete').click();
                        }
                    }
                };
                document.addEventListener('keydown', deletePersonKeyListener);
            }
        }

        // Collapsible entity logic
        function setupCollapsibleEntities() {
            document.querySelectorAll('.collapsible-header').forEach(header => {
                const toggleBtn = header.querySelector('.btn-toggle-entity');
                if (toggleBtn) {
                    // Make the entire header clickable
                    header.style.cursor = 'pointer';
                    header.onclick = function(e) {
                        // Don't trigger if clicking the button directly
                        if (e.target === toggleBtn || toggleBtn.contains(e.target)) {
                            return;
                        }
                        e.preventDefault();
                        const targetId = toggleBtn.getAttribute('data-target');
                        const body = document.querySelector(targetId);
                        if (body) {
                            const expanded = body.classList.toggle('show');
                            toggleBtn.setAttribute('aria-expanded', expanded);
                            // Toggle chevron direction
                            const icon = toggleBtn.querySelector('i');
                            if (icon) {
                                icon.classList.toggle('fa-chevron-down', expanded);
                                icon.classList.toggle('fa-chevron-right', !expanded);
                            }
                        }
                    };
                    
                    // Keep the button click handler for direct button clicks
                    toggleBtn.onclick = function(e) {
                        e.preventDefault();
                        e.stopPropagation(); // Prevent header click from triggering
                        const targetId = this.getAttribute('data-target');
                        const body = document.querySelector(targetId);
                        if (body) {
                            const expanded = body.classList.toggle('show');
                            this.setAttribute('aria-expanded', expanded);
                            // Toggle chevron direction
                            const icon = this.querySelector('i');
                            if (icon) {
                                icon.classList.toggle('fa-chevron-down', expanded);
                                icon.classList.toggle('fa-chevron-right', !expanded);
                            }
                        }
                    };
                }
            });
        }
        // Initial setup for static forms
        setupCollapsibleEntities();

        // Helper to create unique IDs for person forms
        let personFormCount = 1;
        let generatedDataCache = new Map(); // Cache to store generated data for each person
        let hasGeneratedDummyData = false;

        // Helper function to validate form fields
        function validateFormFields(form) {
            const allFields = form.querySelectorAll('input, select, textarea');
            let isValid = true;
            let firstInvalid = null;
            
            allFields.forEach(field => {
                if (field.name === 'meta') {
                    if (field.value.trim()) {
                        try {
                            JSON.parse(field.value);
                            field.classList.remove('is-invalid');
                        } catch (e) {
                            isValid = false;
                            field.classList.add('is-invalid');
                            if (!firstInvalid) firstInvalid = field;
                        }
                    } else {
                        field.classList.remove('is-invalid');
                    }
                } else if (!field.value.trim()) {
                    isValid = false;
                    field.classList.add('is-invalid');
                    if (!firstInvalid) firstInvalid = field;
                } else {
                    if (field.checkValidity()) {
                        field.classList.remove('is-invalid');
                    }
                }
            });
            if (!isValid && firstInvalid) {
                firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' });
                firstInvalid.focus();
            }
            return isValid;
        }

        // Live JSON validation for meta fields
        function attachMetaJsonValidators(context=document) {
            const metaFields = context.querySelectorAll('textarea[name="meta"]');
            metaFields.forEach(field => {
                field.addEventListener('input', function() {
                    const help = this.parentNode.querySelector('.json-help');
                    if (this.value.trim()) {
                        try {
                            JSON.parse(this.value);
                            this.classList.remove('is-invalid');
                            if (help) help.style.display = 'none';
                        } catch (e) {
                            this.classList.add('is-invalid');
                            if (help) help.style.display = '';
                        }
                    } else {
                        this.classList.remove('is-invalid');
                        if (help) help.style.display = 'none';
                    }
                });
            });
        }
        // Attach on page load
        document.addEventListener('DOMContentLoaded', function() {
            attachMetaJsonValidators();
            // Dark mode cookie logic
            const darkModeCookie = document.cookie.split('; ').find(row => row.startsWith('darkMode='));
            if (darkModeCookie) {
                const isDarkMode = darkModeCookie.split('=')[1] === 'true';
                if (isDarkMode) {
                    document.body.classList.add('dark-mode');
                    const toggleButton = document.getElementById('toggleDarkMode');
                    toggleButton.querySelector('i').classList.remove('fa-moon');
                    toggleButton.querySelector('i').classList.add('fa-sun');
                    toggleButton.querySelector('#darkModeToggleText').textContent = 'On';
                }
            }

            // Theme cookie logic
            const themeCookie = document.cookie.split('; ').find(row => row.startsWith('theme='));
            let currentTheme = 'theme-default';
            if (themeCookie) {
                currentTheme = themeCookie.split('=')[1];
                document.body.classList.add(currentTheme);
            }
            // Set theme dropdown value if present
            const themeSelect = document.getElementById('themeSelect');
            if (themeSelect) {
                themeSelect.value = currentTheme;
            }

            // --- PATCH: Set Developer View toggle text to match state on load ---
            const devSection = document.getElementById('devSection');
            const devModeToggleText = document.getElementById('devModeToggleText');
            if (devSection && devModeToggleText) {
                const isDevMode = !devSection.classList.contains('hidden');
                devModeToggleText.textContent = isDevMode ? 'On' : 'Off';
            }
        });
        // Attach when adding new person/representative/business forms
        // For addPersonBtn
        document.getElementById('addPersonBtn').addEventListener('click', function() {
            setTimeout(() => attachMetaJsonValidators(), 0);
        });
        // For addRepresentativeBtn
        document.getElementById('addRepresentativeBtn').addEventListener('click', function() {
            setTimeout(() => attachMetaJsonValidators(), 0);
        });
        // For addBusinessBtn (if business form is dynamically added)
        document.getElementById('addBusinessBtn').addEventListener('click', function() {
            setTimeout(() => attachMetaJsonValidators(), 0);
        });

        // Update addPersonBtn logic
        document.getElementById('addPersonBtn').addEventListener('click', function() {
            const personFormsContainer = document.getElementById('personForms');
            // Count current forms to determine next number
            const currentCount = personFormsContainer.querySelectorAll('.collapsible-entity').length;
            personFormCount = currentCount + 1;
            const template = document.querySelector('.person-form').closest('.collapsible-entity').cloneNode(true);
            // Update the person number and IDs
            template.querySelector('h3').textContent = `Person ${personFormCount}`;
            const collapseId = `personFormCollapse-${personFormCount}`;
            template.querySelector('.collapsible-header .btn-toggle-entity').setAttribute('data-target', `#${collapseId}`);
            template.querySelector('.collapsible-header .btn-toggle-entity').setAttribute('aria-controls', collapseId);
            template.querySelector('.collapsible-body').id = collapseId;
            // Show delete button
            template.querySelector('.delete-person').classList.remove('d-none');
            // Reset form fields
            template.querySelectorAll('input').forEach(input => input.value = '');
            // Collapse the new form by default
            template.querySelector('.collapsible-body').classList.add('show');
            template.querySelector('.btn-toggle-entity').setAttribute('aria-expanded', 'true');
            const icon = template.querySelector('.btn-toggle-entity i');
            if (icon) {
                icon.classList.add('fa-chevron-down');
                icon.classList.remove('fa-chevron-right');
            }
            // Add delete event listener
            template.querySelector('.delete-person').addEventListener('click', function(e) {
                e.stopPropagation();
                const deleteModal = document.getElementById('deletePersonModal');
                deleteModal.style.display = 'flex';
                setDeleteTemplate(template);
            });
            // Add collapsible toggle event
            template.querySelector('.btn-toggle-entity').onclick = function(e) {
                e.preventDefault();
                const body = template.querySelector('.collapsible-body');
                const expanded = body.classList.toggle('show');
                this.setAttribute('aria-expanded', expanded);
                const icon = this.querySelector('i');
                if (icon) {
                    icon.classList.toggle('fa-chevron-down', expanded);
                    icon.classList.toggle('fa-chevron-right', !expanded);
                }
            };
            personFormsContainer.appendChild(template);
            // Smooth expand: remove .show, then add it on next frame
            const collapsibleBody = template.querySelector('.collapsible-body');
            collapsibleBody.classList.remove('show');
            requestAnimationFrame(() => {
                collapsibleBody.classList.add('show');
            });
            // If dummy data has been generated before, generate new data for this person and clear validation
            if (hasGeneratedDummyData) {
                generateUniqueDummyData(template.querySelector('form'));
                template.querySelectorAll('input, select, textarea').forEach(field => {
                    // Remove all .invalid-feedback elements in the same parent
                    const parent = field.parentNode;
                    parent.querySelectorAll('.invalid-feedback').forEach(err => err.remove());
                    // Forcefully remove is-invalid and aria-invalid
                    field.classList.remove('is-invalid');
                    field.removeAttribute('aria-invalid');
                    if (typeof field.setCustomValidity === 'function') {
                        field.setCustomValidity('');
                    }
                });
            }
        });

        // Close modal when clicking outside
        document.getElementById('deletePersonModal').addEventListener('click', function(e) {
            if (e.target === this) {
                this.style.display = 'none';
                templateToDelete = null;
            }
        });

        // Function to generate unique dummy data for a form
        function generateUniqueDummyData(form) {
            if (typeof window.fakerUtils === 'undefined') {
                console.error('Faker utils are not available');
                return;
            }

            let data;
            let isUnique = false;
            let attempts = 0;
            const maxAttempts = 10;

            // Try to generate unique data
            while (!isUnique && attempts < maxAttempts) {
                data = window.fakerUtils.generateSampleData();
                isUnique = true;

                // Check if this data is already used
                for (const cachedData of generatedDataCache.values()) {
                    if (cachedData.email === data.email || 
                        cachedData.phone === data.phone || 
                        cachedData.ssn === data.ssn) {
                        isUnique = false;
                        break;
                    }
                }
                attempts++;
            }

            if (isUnique) {
                // Store the generated data in cache
                generatedDataCache.set(form, data);
                
                // Fill the form with the generated data, but only if the field is empty and not set by a Sandbox Profile
                const nameFirstInput = form.querySelector('[name="name_first"]');
                const nameLastInput = form.querySelector('[name="name_last"]');
                const emailInput = form.querySelector('[name="email_address"]');
                const phoneInput = form.querySelector('[name="phone_number"]');
                const ssnInput = form.querySelector('[name="document_ssn"]');
                const birthDateInput = form.querySelector('[name="birth_date"]');
                const ipAddressInput = form.querySelector('[name="ip_address"]');
                const line1Input = form.querySelector('[name="line_1"]');
                const cityInput = form.querySelector('[name="city"]');
                const stateInput = form.querySelector('[name="state"]');
                const postalCodeInput = form.querySelector('[name="postal_code"]');

                if (nameFirstInput && !nameFirstInput.value && !nameFirstInput.hasAttribute('data-sandbox-profile')) nameFirstInput.value = data.firstName;
                if (nameLastInput && !nameLastInput.value && !nameLastInput.hasAttribute('data-sandbox-profile')) nameLastInput.value = data.lastName;
                if (emailInput && !emailInput.value && !emailInput.hasAttribute('data-sandbox-profile')) emailInput.value = data.email;
                if (phoneInput && !phoneInput.value && !phoneInput.hasAttribute('data-sandbox-profile')) phoneInput.value = data.phone;
                if (ssnInput && !ssnInput.value && !ssnInput.hasAttribute('data-sandbox-profile')) ssnInput.value = data.ssn;
                if (birthDateInput && !birthDateInput.value && !birthDateInput.hasAttribute('data-sandbox-profile')) birthDateInput.value = data.birthDate;
                if (ipAddressInput && !ipAddressInput.value && !ipAddressInput.hasAttribute('data-sandbox-profile')) ipAddressInput.value = data.ipAddress;
                if (line1Input && !line1Input.value && !line1Input.hasAttribute('data-sandbox-profile')) line1Input.value = data.streetAddress;
                if (cityInput && !cityInput.value && !cityInput.hasAttribute('data-sandbox-profile')) cityInput.value = data.city;
                if (stateInput && !stateInput.value && !stateInput.hasAttribute('data-sandbox-profile')) stateInput.value = data.state;
                if (postalCodeInput && !postalCodeInput.value && !postalCodeInput.hasAttribute('data-sandbox-profile')) postalCodeInput.value = data.zipCode;

                // Always set country to US, even if it was previously set
                const countrySelect = form.querySelector('select[name="country_code"]');
                if (countrySelect && !countrySelect.hasAttribute('data-sandbox-profile')) {
                    countrySelect.value = 'US';
                    countrySelect.dispatchEvent(new Event('change'));
                }
            } else {
                console.warn('Could not generate unique data after multiple attempts');
            }
        }

        // Update the prefill functionality to include representatives
        document.getElementById('prefillBtn').addEventListener('click', function() {
            if (typeof window.fakerUtils === 'undefined') {
                console.error('Faker utils are not available');
                return;
            }
            
            // Clear the cache when generating new data
            generatedDataCache.clear();
            hasGeneratedDummyData = true;
            
            // Generate unique data for each person form
            document.querySelectorAll('.person-form').forEach(form => {
                generateUniqueDummyData(form);
                // Remove validation errors for filled fields
                form.querySelectorAll('input, select, textarea').forEach(field => {
                    if (field.checkValidity()) {
                        field.classList.remove('is-invalid');
                        // Remove all .invalid-feedback elements in the same parent
                        const parent = field.parentNode;
                        parent.querySelectorAll('.invalid-feedback').forEach(err => err.remove());
                    }
                });
            });

            // Generate unique data for each representative form
            document.querySelectorAll('.representative-form').forEach(form => {
                generateUniqueDummyData(form);
                // Remove validation errors for filled fields
                form.querySelectorAll('input, select, textarea').forEach(field => {
                    if (field.checkValidity()) {
                        field.classList.remove('is-invalid');
                        // Remove all .invalid-feedback elements in the same parent
                        const parent = field.parentNode;
                        parent.querySelectorAll('.invalid-feedback').forEach(err => err.remove());
                    }
                });
            });

            // Fill business form if present and visible
            const businessForm = document.querySelector('.business-form');
            if (businessForm && businessForm.closest('#businessFormContainer') && businessForm.closest('#businessFormContainer').style.display !== 'none') {
                // Use the same Faker utility as for persons/representatives
                const data = window.fakerUtils.generateSampleData();
                // Map sample data to business fields
                businessForm.querySelector('[name="business_name"]').value = data.firstName + ' ' + data.lastName + ' LLC';
                businessForm.querySelector('[name="business_federal_ein"]').value = Math.floor(100000000 + Math.random() * 900000000).toString();
                businessForm.querySelector('[name="business_phone_number"]').value = data.phone;
                businessForm.querySelector('[name="business_type"]').value = '01';
                businessForm.querySelector('[name="business_registry_id"]').value = Math.random().toString(36).substring(2, 10).toUpperCase();
                businessForm.querySelector('[name="business_url"]').value = 'https://www.' + data.lastName.toLowerCase() + '.com';
                businessForm.querySelector('[name="business_alternate_name"]').value = data.firstName + ' Holdings';
                businessForm.querySelector('[name="line_1"]').value = data.streetAddress;
                businessForm.querySelector('[name="city"]').value = data.city;
                businessForm.querySelector('[name="state"]').value = data.state;
                businessForm.querySelector('[name="postal_code"]').value = data.zipCode;
                // Remove validation errors for all fields
                businessForm.querySelectorAll('input, select, textarea').forEach(field => {
                    // Remove all .invalid-feedback elements in the same parent
                    const parent = field.parentNode;
                    parent.querySelectorAll('.invalid-feedback').forEach(err => err.remove());
                    // Forcefully remove is-invalid and aria-invalid
                    field.classList.remove('is-invalid');
                    field.removeAttribute('aria-invalid');
                    if (typeof field.setCustomValidity === 'function') {
                        field.setCustomValidity('');
                    }
                });
            }

            // Hide profile indicator with transition
            hideProfileIndicator();

            // Set country dropdowns for all forms (Person, Business, Representative)
            document.querySelectorAll('select[name="country_code"]').forEach(select => {
                select.value = 'US';
                select.dispatchEvent(new Event('change'));
            });
        });

        // Update addBusinessBtn logic
        document.getElementById('addBusinessBtn').addEventListener('click', function() {
            document.getElementById('businessFormContainer').style.display = 'block';
            document.getElementById('addRepresentativeContainer').style.display = 'block';
            this.disabled = true;
            // If dummy data has been generated, populate the business form and clear validation
            if (hasGeneratedDummyData) {
                const businessForm = document.querySelector('.business-form');
                if (businessForm) {
                    // Use the same Faker utility as for persons/representatives
                    const data = window.fakerUtils.generateSampleData();
                    // Map sample data to business fields
                    businessForm.querySelector('[name="business_name"]').value = data.firstName + ' ' + data.lastName + ' LLC';
                    businessForm.querySelector('[name="business_federal_ein"]').value = Math.floor(100000000 + Math.random() * 900000000).toString();
                    businessForm.querySelector('[name="business_phone_number"]').value = data.phone;
                    businessForm.querySelector('[name="business_type"]').value = '01';
                    businessForm.querySelector('[name="business_registry_id"]').value = Math.random().toString(36).substring(2, 10).toUpperCase();
                    businessForm.querySelector('[name="business_url"]').value = 'https://www.' + data.lastName.toLowerCase() + '.com';
                    businessForm.querySelector('[name="business_alternate_name"]').value = data.firstName + ' Holdings';
                    businessForm.querySelector('[name="line_1"]').value = data.streetAddress;
                    businessForm.querySelector('[name="city"]').value = data.city;
                    businessForm.querySelector('[name="state"]').value = data.state;
                    businessForm.querySelector('[name="postal_code"]').value = data.zipCode;
                    // Remove validation errors for all fields
                    businessForm.querySelectorAll('input, select, textarea').forEach(field => {
                        // Remove all .invalid-feedback elements in the same parent
                        const parent = field.parentNode;
                        parent.querySelectorAll('.invalid-feedback').forEach(err => err.remove());
                        // Forcefully remove is-invalid and aria-invalid
                        field.classList.remove('is-invalid');
                        field.removeAttribute('aria-invalid');
                        if (typeof field.setCustomValidity === 'function') {
                            field.setCustomValidity('');
                        }
                    });
                }
            }
        });
        document.querySelector('.delete-business').addEventListener('click', function(e) {
            e.stopPropagation();
            const deleteModal = document.getElementById('deleteBusinessModal');
            deleteModal.style.display = 'flex';
            // Focus the delete button
            deleteModal.querySelector('#confirmDeleteBusiness').focus();
        });
        document.getElementById('cancelDeleteBusiness').addEventListener('click', function() {
            const modal = document.getElementById('deleteBusinessModal');
            modal.style.display = 'none';
        });
        document.getElementById('confirmDeleteBusiness').addEventListener('click', function() {
            document.getElementById('businessFormContainer').style.display = 'none';
            document.getElementById('addRepresentativeContainer').style.display = 'none';
            document.getElementById('addBusinessBtn').disabled = false;
            const modal = document.getElementById('deleteBusinessModal');
            modal.style.display = 'none';
            // Clear any existing representative forms
            document.getElementById('representativeForms').innerHTML = '';
            representativeCount = 0;
        });
        document.getElementById('deleteBusinessModal').addEventListener('click', function(e) {
            if (e.target === this) {
                this.style.display = 'none';
            }
        });

        // Add Representative Button Logic
        document.getElementById('addRepresentativeBtn').addEventListener('click', function() {
            const representativeFormsContainer = document.getElementById('representativeForms');
            const addRepContainer = document.getElementById('addRepresentativeContainer');
            const template = document.getElementById('representativeFormTemplate');
            
            // Create a new representative form
            const clone = template.querySelector('.collapsible-entity').cloneNode(true);
            clone.style.display = 'block';
            
            // Count current representatives to determine the number
            const currentCount = representativeFormsContainer.querySelectorAll('.collapsible-entity').length;
            const newCount = currentCount + 1;
            
            // Update the representative number and IDs
            clone.querySelector('h3').textContent = `Representative ${newCount}`;
            const collapseId = `representativeFormCollapse-${newCount}`;
            clone.querySelector('.btn-toggle-entity').setAttribute('data-target', `#${collapseId}`);
            clone.querySelector('.btn-toggle-entity').setAttribute('aria-controls', collapseId);
            clone.querySelector('.collapsible-body').id = collapseId;
            
            // Add delete event listener
            clone.querySelector('.delete-representative').addEventListener('click', function(e) {
                e.stopPropagation();
                const deleteModal = document.getElementById('deletePersonModal');
                const modalTitle = deleteModal.querySelector('.modal-title');
                const deleteButton = deleteModal.querySelector('#confirmDelete');
                modalTitle.textContent = 'Confirm Representative Deletion';
                deleteButton.innerHTML = '<i class="fas fa-trash"></i> Delete Rep';
                deleteModal.style.display = 'flex';
                setDeleteTemplate(clone);
                deleteButton.focus();
            });
            
            // Add expand/collapse event listener
            clone.querySelector('.btn-toggle-entity').onclick = function(e) {
                e.preventDefault();
                const body = clone.querySelector('.collapsible-body');
                const expanded = body.classList.toggle('show');
                this.setAttribute('aria-expanded', expanded);
                const icon = this.querySelector('i');
                if (icon) {
                    icon.classList.toggle('fa-chevron-down', expanded);
                    icon.classList.toggle('fa-chevron-right', !expanded);
                }
            };
            
            // If dummy data has been generated before, generate new data for this representative
            if (hasGeneratedDummyData) {
                generateUniqueDummyData(clone.querySelector('form'));
                clone.querySelectorAll('input, select, textarea').forEach(field => {
                    const parent = field.parentNode;
                    parent.querySelectorAll('.invalid-feedback').forEach(err => err.remove());
                    field.classList.remove('is-invalid');
                    field.removeAttribute('aria-invalid');
                    if (typeof field.setCustomValidity === 'function') {
                        field.setCustomValidity('');
                    }
                });
            }
            
            // Add the new representative form
            representativeFormsContainer.appendChild(clone);
            // Smooth expand: remove .show, then add it on next frame
            const repCollapsibleBody = clone.querySelector('.collapsible-body');
            repCollapsibleBody.classList.remove('show');
            requestAnimationFrame(() => {
                repCollapsibleBody.classList.add('show');
            });
            
            // Ensure the container is visible
            representativeFormsContainer.style.display = '';
            if (addRepContainer) {
                addRepContainer.style.marginBottom = '1.5rem';
            }
            
            // Show the representative section container
            document.getElementById('representativeSectionContainer').style.display = '';

            // Set country dropdown for the new representative
            setTimeout(() => {
                const repForms = document.querySelectorAll('.representative-form');
                if (repForms.length) {
                    const lastRepForm = repForms[repForms.length - 1];
                    const countrySelect = lastRepForm.querySelector('select[name="country_code"]');
                    if (countrySelect) {
                        countrySelect.value = 'US';
                        countrySelect.dispatchEvent(new Event('change'));
                    }
                }
            }, 0);
        });

        // Update form submission logic to include representatives
        document.getElementById('submitBtn').addEventListener('click', async function(e) {
            e.preventDefault();
            
            // Validate all forms
            const personForms = document.querySelectorAll('.person-form');
            const businessForm = document.querySelector('.business-form');
            const representativeForms = document.querySelectorAll('.representative-form');
            let allValid = true;
            
            // Check person forms
            personForms.forEach((form, idx) => {
                const valid = validateFormFields(form);
                if (!valid) {
                    allValid = false;
                }
            });
            
            // Check business form if visible
            let businessVisible = false;
            if (businessForm && businessForm.closest('#businessFormContainer') && 
                businessForm.closest('#businessFormContainer').style.display !== 'none') {
                businessVisible = true;
                const valid = validateFormFields(businessForm);
                if (!valid) {
                    allValid = false;
                }
            }

            // Only validate representatives if business is visible
            if (businessVisible) {
                representativeForms.forEach((form, idx) => {
                    const valid = validateFormFields(form);
                    if (!valid) {
                        allValid = false;
                    }
                });
            }
            
            if (!allValid) {
                const firstInvalid = document.querySelector('.is-invalid');
                if (firstInvalid) {
                    firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    firstInvalid.focus();
                }
                return;
            }
            
            // Hide the profile indicator with transition
            hideProfileIndicator();
            
            // Hide all action buttons
            document.getElementById('addPersonBtn').style.display = 'none';
            document.getElementById('addBusinessBtn').style.display = 'none';
            document.getElementById('addRepresentativeBtn').style.display = 'none';
            document.getElementById('prefillBtn').style.display = 'none';
            document.getElementById('submitBtn').style.display = 'none';
            
            // Hide the entire action row (including Sandbox Profiles dropdown)
            const actionRow = document.getElementById('actionRow');
            if (actionRow) actionRow.style.display = 'none';
            
            // Hide the sandbox profiles dropdown and button
            const sandboxProfilesSection = document.getElementById('sandboxProfilesSection');
            if (sandboxProfilesSection) sandboxProfilesSection.style.display = 'none';
            const sandboxProfilesDropdown = document.querySelector('.dropdown-menu');
            if (sandboxProfilesDropdown) {
                sandboxProfilesDropdown.classList.remove('show');
                sandboxProfilesDropdown.style.display = 'none';
            }
            const sandboxProfilesButton = document.querySelector('.dropdown-toggle');
            if (sandboxProfilesButton) {
                sandboxProfilesButton.setAttribute('aria-expanded', 'false');
                sandboxProfilesButton.style.display = 'none';
            }
            
            // Hide all form-related entity sections after submission
            document.querySelectorAll('#personForms .collapsible-entity, #businessFormContainer .collapsible-entity, #representativeForms .collapsible-entity').forEach(entity => {
                if (entity) entity.style.display = 'none';
            });
            
            // Hide the expand/collapse all button
            const toggleAllBtn = document.getElementById('toggleAllEntitiesBtn');
            if (toggleAllBtn) toggleAllBtn.style.display = 'none';

            // Keep the settings button and modal visible
            const keyboardShortcutsBtn = document.getElementById('keyboardShortcutsBtn');
            if (keyboardShortcutsBtn) keyboardShortcutsBtn.style.display = '';
            const keyboardShortcutsModal = document.getElementById('keyboardShortcutsModal');
            if (keyboardShortcutsModal) keyboardShortcutsModal.style.display = '';

            showProcessingModal('Submitting application to Alloy...');
            
            try {
                const entities = [];

                // Add business entity if present
                if (businessForm && businessForm.closest('#businessFormContainer') && businessForm.closest('#businessFormContainer').style.display !== 'none') {
                    const formData = new FormData(businessForm);
                    const representatives = [];
                    
                    // Add representatives
                    document.querySelectorAll('.representative-form').forEach((form, index) => {
                        const repFormData = new FormData(form);
                        const phoneNumber = formatPhoneToE164(repFormData.get('phone_number'));
                        representatives.push({
                            name_first: repFormData.get('name_first'),
                            name_last: repFormData.get('name_last'),
                            email_address: repFormData.get('email_address'),
                            phone_number: phoneNumber,
                            document_ssn: repFormData.get('document_ssn'),
                            birth_date: repFormData.get('birth_date'),
                            type: index === 0 ? "principal_owner" : "authorized_signer",
                            addresses: [
                                {
                                    type: "primary",
                                    line_1: repFormData.get('line_1'),
                                    city: repFormData.get('city'),
                                    state: repFormData.get('state'),
                                    postal_code: repFormData.get('postal_code'),
                                    country_code: repFormData.get('country_code')
                                }
                            ],
                            meta: repFormData.get('meta') ? JSON.parse(repFormData.get('meta')) : {}
                        });
                    });

                    const businessPhoneNumber = formatPhoneToE164(formData.get('business_phone_number'));
                    entities.push({
                        entity_type: "business",
                        branch_name: "businesses",
                        external_entity_id: crypto.randomUUID(),
                        business_type: formData.get('business_type'),
                        business_name: formData.get('business_name'),
                        business_federal_ein: formData.get('business_federal_ein'),
                        business_url: formData.get('business_url'),
                        business_phone_number: businessPhoneNumber,
                        business_alternate_name: formData.get('business_alternate_name'),
                        business_registry_id: formData.get('business_registry_id'),
                        addresses: [
                            {
                                type: "business_primary",
                                line_1: formData.get('line_1'),
                                city: formData.get('city'),
                                state: formData.get('state'),
                                postal_code: formData.get('postal_code'),
                                country_code: formData.get('country_code')
                            }
                        ],
                        representatives: representatives,
                        meta: formData.get('meta') ? JSON.parse(formData.get('meta')) : {}
                    });
                }

                // Add person entities
                personForms.forEach(form => {
                    const formData = new FormData(form);
                    const phoneNumber = formatPhoneToE164(formData.get('phone_number'));
                    entities.push({
                        entity_type: "person",
                        branch_name: "persons",
                        data: {
                            name_first: formData.get('name_first'),
                            name_last: formData.get('name_last'),
                            birth_date: formData.get('birth_date'),
                            phone_number: phoneNumber,
                            email_address: formData.get('email_address'),
                            document_ssn: formData.get('document_ssn'),
                            ip_address_v4: formData.get('ip_address'),
                            device: {},
                            meta: formData.get('meta') ? JSON.parse(formData.get('meta')) : {},
                            addresses: [
                                {
                                    type: "primary",
                                    line_1: formData.get('line_1'),
                                    city: formData.get('city'),
                                    state: formData.get('state'),
                                    postal_code: formData.get('postal_code'),
                                    country_code: formData.get('country_code')
                                }
                            ]
                        }
                    });
                });

                const data = {
                    external_application_id: crypto.randomUUID(),
                    external_partner_id: crypto.randomUUID(),
                    entities: entities
                };

                // Store the data for potential re-run
                lastSubmittedData = JSON.parse(JSON.stringify(data));

                // Show request in developer mode
                document.getElementById('requestView').textContent = JSON.stringify(data, null, 2);

                const response = await withMinimumLoadingTime(
                    fetch('/api/submit-application', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(data)
                    })
                );
                
                const result = await response.json();
                document.getElementById('responseView').textContent = JSON.stringify(result, null, 2);

                // Automatically expand the response section
                const responseCollapse = document.getElementById('responseViewCollapse');
                if (responseCollapse && !responseCollapse.classList.contains('show')) {
                    responseCollapse.classList.add('show');
                    // Update the toggle button's aria-expanded and chevron icon
                    const toggleBtn = document.querySelector('button[data-target="#responseViewCollapse"]');
                    if (toggleBtn) {
                        toggleBtn.setAttribute('aria-expanded', 'true');
                        const icon = toggleBtn.querySelector('i');
                        if (icon) {
                            icon.classList.add('fa-chevron-down');
                            icon.classList.remove('fa-chevron-right');
                        }
                    }
                }

                // Handle different statuses
                if (result.journey_application_status === 'Approved') {
                    showStatusMessage('approvedMessage');
                } else if (result.journey_application_status === 'Denied') {
                    showStatusMessage('deniedMessage');
                } else if (result.journey_application_status === 'Manual Review') {
                    showStatusMessage('manualReviewMessage');
                } else if (result.journey_application_status === 'Pending') {
                    // Check if step-up is required for any entity
                    const entityApps = result._embedded?.entity_applications || [];
                    const needsStepUp = entityApps.some(app => app.entity_application_status === 'pending_step_up');
                    if (needsStepUp && result.journey_application_token) {
                        lastJourneyApplicationToken = result.journey_application_token;
                        sdkStepUpAvailable = true;
                        showStatusMessage('pendingMessage');
                        showProcessingModal('Initializing additional verification...');
                        try {
                            await initializeAlloySDK(result.journey_application_token);
                        } catch (error) {
                            console.error('Error during step-up verification:', error);
                            showStatusMessage('manualReviewMessage');
                            hideProcessingModal();
                        }
                        return;
                    } else {
                        showStatusMessage('manualReviewMessage');
                    }
                } else {
                    // Check if any entity is pending_step_up even if journey status is not 'Pending'
                    const entityApps = result._embedded?.entity_applications || [];
                    const needsStepUp = entityApps.some(app => app.entity_application_status === 'pending_step_up');
                    if (needsStepUp && result.journey_application_token) {
                        showStatusMessage('pendingMessage');
                        showProcessingModal('Initializing additional verification...');
                        try {
                            await initializeAlloySDK(result.journey_application_token);
                        } catch (error) {
                            console.error('Error during step-up verification:', error);
                            showStatusMessage('manualReviewMessage');
                            hideProcessingModal();
                        }
                    } else {
                        // Default to manual review for unknown statuses
                        showStatusMessage('manualReviewMessage');
                    }
                }

                const jaToken = result.journey_application_token;
                const jToken = alloyConfig.journeyToken; // from .env/config
                let dashboardUrl = '';
                const baseUrl = alloyConfig.baseUrl || '';
                if (baseUrl.includes('api.alloy.co') || baseUrl.includes('sandbox.alloy.co')) {
                    dashboardUrl = `https://app.alloy.co/v3/dashboard/journeys/${jToken}/applications/${jaToken}`;
                } else {
                    // Extract the client name before .api or .sandbox
                    const match = baseUrl.match(/^https:\/\/([^\.]+)/);
                    const client = match ? match[1] : 'client';
                    dashboardUrl = `https://${client}.app.alloy.com/v3/dashboard/journeys/${jToken}/applications/${jaToken}`;
                }
                // Store full application data for re-run, with timestamp and person 1 name
                const now = new Date();
                let person1 = { first: '', last: '' };
                try {
                  const p1 = data.entities.find(e => e.entity_type === 'person');
                  if (p1 && p1.data) {
                    person1.first = p1.data.name_first || '';
                    person1.last = p1.data.name_last || '';
                  }
                } catch {}
                // Fix: Always keep most recent application at the front of the array
                window.applicationLinks.unshift({
                  jaToken,
                  url: dashboardUrl,
                  data: JSON.parse(JSON.stringify(data)),
                  submittedAt: now.toISOString(),
                  person1,
                  status: result.journey_application_status || ''
                });
                try {
                    await window.api.saveApplicationHistory(window.applicationLinks);
                } catch (error) {
                    console.error('Error saving application history:', error);
                }
                // Auto-show the FAB popover after submission
                setTimeout(() => {
                    const fabBtn = document.getElementById('dashboardLinksFab');
                    if (fabBtn) fabBtn.click();
                }, 500);
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('responseView').textContent = JSON.stringify({ error: error.message }, null, 2);
                alert('An error occurred while processing your application. Please try again.');
            } finally {
                hideProcessingModal();
            }
        });

        // Collapse/Expand All button logic
        let allCollapsed = false;
        document.getElementById('toggleAllEntitiesBtn').addEventListener('click', function() {
            allCollapsed = !allCollapsed;
            document.querySelectorAll('.collapsible-entity').forEach(entity => {
                const body = entity.querySelector('.collapsible-body');
                const toggleBtn = entity.querySelector('.btn-toggle-entity');
                const icon = toggleBtn.querySelector('i');
                if (body && toggleBtn && icon) {
                    if (allCollapsed) {
                        body.classList.remove('show');
                        toggleBtn.setAttribute('aria-expanded', 'false');
                        icon.classList.remove('fa-chevron-down');
                        icon.classList.add('fa-chevron-right');
                    } else {
                        body.classList.add('show');
                        toggleBtn.setAttribute('aria-expanded', 'true');
                        icon.classList.add('fa-chevron-down');
                        icon.classList.remove('fa-chevron-right');
                    }
                }
            });
            // Update the main button icon and tooltip
            const mainIcon = this.querySelector('i');
            if (allCollapsed) {
                mainIcon.classList.remove('fa-compress-alt');
                mainIcon.classList.add('fa-expand-alt');
                this.title = 'Expand All';
            } else {
                mainIcon.classList.add('fa-compress-alt');
                mainIcon.classList.remove('fa-expand-alt');
                this.title = 'Collapse All';
            }
        });

        // Initialize keyboard shortcuts modal
        let keyboardShortcutsModal = null;

        // Initialize the modal
        document.addEventListener('DOMContentLoaded', function() {
            const modalElement = document.getElementById('keyboardShortcutsModal');
            if (modalElement) {
                keyboardShortcutsModal = new bootstrap.Modal(modalElement, {
                    keyboard: true
                });
            }

            // Show keyboard shortcut notification on first visit
            if (!localStorage.getItem('keyboardShortcutNotified')) {
                setTimeout(() => {
                    showNotification('Press ⌘/Ctrl + , for Settings & Shortcuts', 'info');
                    localStorage.setItem('keyboardShortcutNotified', 'true');
                }, 1000); // Delay by 1 second to let the page fully load
            }

            // Handle keyboard shortcuts button click
            const keyboardShortcutsBtn = document.getElementById('keyboardShortcutsBtn');
            if (keyboardShortcutsBtn) {
                keyboardShortcutsBtn.addEventListener('click', function() {
                    if (keyboardShortcutsModal) {
                        keyboardShortcutsModal.show();
                    }
                });
            }

            // Add dark mode toggle functionality
            const toggleDarkModeBtn = document.getElementById('toggleDarkMode');
            if (toggleDarkModeBtn) {
                toggleDarkModeBtn.addEventListener('click', function() {
                    document.body.classList.toggle('dark-mode');
                    const isDarkMode = document.body.classList.contains('dark-mode');
                    this.querySelector('i').classList.toggle('fa-moon', !isDarkMode);
                    this.querySelector('i').classList.toggle('fa-sun', isDarkMode);
                    this.querySelector('#darkModeToggleText').textContent = isDarkMode ? 'On' : 'Off';
                    // Save preference to cookie
                    document.cookie = `darkMode=${isDarkMode}; path=/; max-age=31536000`;
                    // Update Shepherd tour appearance if active
                    const shepherdElements = document.querySelectorAll('.shepherd-element');
                    shepherdElements.forEach(el => {
                        if (isDarkMode) {
                            el.classList.add('shepherd-dark');
                        } else {
                            el.classList.remove('shepherd-dark');
                        }
                    });
                });
            }

            // Add developer mode toggle functionality
            const toggleDevModeBtn = document.getElementById('toggleDevMode');
            if (toggleDevModeBtn) {
                toggleDevModeBtn.addEventListener('click', function() {
                    const devSection = document.getElementById('devSection');
                    const formSection = document.querySelector('.form-section');
                    const isDevMode = !devSection.classList.contains('hidden');
                    if (!isDevMode) {
                        devSection.classList.remove('hidden');
                        formSection.style.flex = '0 0 50%';
                    } else {
                        devSection.classList.add('hidden');
                        formSection.style.flex = '0 0 100%';
                    }
                    this.querySelector('#devModeToggleText').textContent = !isDevMode ? 'On' : 'Off';
                });
            }
        });

        // Notification system
        const recentNotifications = new Set();
        function showNotification(message, type = 'info') {
            const key = `${type}:${message}`;
            if (recentNotifications.has(key)) return;
            recentNotifications.add(key);
            setTimeout(() => recentNotifications.delete(key), 3000);
            const container = document.getElementById('notificationContainer');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            // Create icon based on type
            let icon = '';
            switch(type) {
                case 'success':
                    icon = '<i class="fas fa-check-circle"></i>';
                    break;
                case 'error':
                    icon = '<i class="fas fa-exclamation-circle"></i>';
                    break;
                default:
                    icon = '<i class="fas fa-info-circle"></i>';
            }
            notification.innerHTML = `
                <div class="notification-content">
                    ${icon}
                    <span>${message}</span>
                </div>
            `;
            container.appendChild(notification);
            // Trigger animation
            setTimeout(() => {
                notification.classList.add('show');
            }, 10);
            // Auto-dismiss after 3 seconds
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, 3000);
        }

        // Add keyboard shortcuts functionality
        document.addEventListener('keydown', function(e) {
            // Check if we're in an input field
            const isInput = e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA';
            
            // Only trigger shortcuts if not in an input field or if it's a specific shortcut
            if (!isInput || e.key === 'Escape') {
                // Command/Control + , to open settings
                if ((e.metaKey || e.ctrlKey) && e.key === ',') {
                    e.preventDefault();
                    if (keyboardShortcutsModal) {
                        keyboardShortcutsModal.show();
                    }
                }
                // Command/Control + Shift + L to open recent applications
                else if ((e.metaKey || e.ctrlKey) && e.shiftKey && e.key.toLowerCase() === 'l') {
                    e.preventDefault();
                    const fabBtn = document.getElementById('dashboardLinksFab');
                    if (fabBtn) {
                        showNotification('Opening recent applications...', 'info');
                        fabBtn.click();
                    }
                }
                // Command/Control + Shift + D to clear history
                else if ((e.metaKey || e.ctrlKey) && e.shiftKey && e.key.toLowerCase() === 'd') {
                    e.preventDefault();
                    showNotification('Clearing application history...', 'info');
                    document.getElementById('clearStorageBtn').click();
                }
                // Command/Control + Enter to submit
                else if ((e.metaKey || e.ctrlKey) && e.key === 'Enter') {
                    e.preventDefault();
                    showNotification('Submitting application...', 'info');
                    document.getElementById('submitBtn').click();
                }
                // Command/Control + Shift + F to pre-fill
                else if ((e.metaKey || e.ctrlKey) && e.shiftKey && e.key.toLowerCase() === 'f') {
                    e.preventDefault();
                    showNotification('Pre-filling dummy data...', 'info');
                    document.getElementById('prefillBtn').click();
                }
                // Command/Control + Shift + I to add person
                else if ((e.metaKey || e.ctrlKey) && e.shiftKey && e.key.toLowerCase() === 'i') {
                    e.preventDefault();
                    showNotification('Adding new person...', 'success');
                    document.getElementById('addPersonBtn').click();
                }
                // Command/Control + Shift + B to add business
                else if ((e.metaKey || e.ctrlKey) && e.shiftKey && e.key.toLowerCase() === 'b') {
                    e.preventDefault();
                    showNotification('Adding new business...', 'success');
                    document.getElementById('addBusinessBtn').click();
                }
                // Command/Control + Shift + A to add representative
                else if ((e.metaKey || e.ctrlKey) && e.shiftKey && e.key.toLowerCase() === 'a') {
                    e.preventDefault();
                    // Check if business form is visible
                    const businessFormContainer = document.getElementById('businessFormContainer');
                    if (businessFormContainer && businessFormContainer.style.display !== 'none') {
                        showNotification('Adding new representative...', 'success');
                        document.getElementById('addRepresentativeBtn').click();
                    } else {
                        showNotification('Please add a business first', 'error');
                    }
                }
                // Command/Control + Shift + M to toggle dark mode
                else if ((e.metaKey || e.ctrlKey) && e.shiftKey && e.key.toLowerCase() === 'm') {
                    e.preventDefault();
                    const isDarkMode = document.body.classList.contains('dark-mode');
                    showNotification(`Switching to ${isDarkMode ? 'light' : 'dark'} mode...`, 'info');
                    document.getElementById('toggleDarkMode').click();
                }
                // Command/Control + Shift + V to toggle developer view
                else if ((e.metaKey || e.ctrlKey) && e.shiftKey && e.key.toLowerCase() === 'v') {
                    e.preventDefault();
                    const isDevMode = !document.getElementById('devSection').classList.contains('hidden');
                    showNotification(`${!isDevMode ? 'Showing' : 'Hiding'} developer view...`, 'info');
                    document.getElementById('toggleDevMode').click();
                }
                // Command/Control + Shift + E to re-run last app
                else if ((e.metaKey || e.ctrlKey) && e.shiftKey && e.key.toLowerCase() === 'e') {
                    e.preventDefault();
                    if (lastSubmittedData) {
                        showNotification("Restoring last application's data to form(s)", 'info');
                        rerunLastApp();
                    } else {
                        showNotification('No previous application data found', 'error');
                    }
                }
                // Esc to close modals
                else if (e.key === 'Escape') {
                    // Close all modals
                    document.querySelectorAll('.modal-overlay').forEach(modal => {
                        if (modal.style.display === 'flex') {
                            modal.style.display = 'none';
                        }
                    });
                }
            }
        });
        
        // Handle re-running the last app
        function rerunLastApp() {
            if (!lastSubmittedData) {
                showNotification('No previous application data found', 'error');
                return;
            }

            // Reset the UI state
            const addPersonBtn = document.getElementById('addPersonBtn');
            const addBusinessBtn = document.getElementById('addBusinessBtn');
            const addRepresentativeBtn = document.getElementById('addRepresentativeBtn');
            const prefillBtn = document.getElementById('prefillBtn');
            const submitBtn = document.getElementById('submitBtn');
            const actionRow = document.getElementById('actionRow');
            const mb4 = document.querySelector('.mb-4');
            const dropdownMenu = document.querySelector('.dropdown-menu');
            const dropdownToggle = document.querySelector('.dropdown-toggle');
            const toggleAllBtn = document.getElementById('toggleAllEntitiesBtn');

            // Show all buttons and containers
            if (addPersonBtn) addPersonBtn.style.display = '';
            if (addBusinessBtn) addBusinessBtn.style.display = '';
            if (addRepresentativeBtn) addRepresentativeBtn.style.display = '';
            if (prefillBtn) prefillBtn.style.display = '';
            if (submitBtn) submitBtn.style.display = '';
            if (actionRow) actionRow.style.display = '';
            if (mb4) mb4.style.display = '';
            if (dropdownMenu) {
                dropdownMenu.classList.remove('show');
                dropdownMenu.style.display = '';
            }
            if (dropdownToggle) {
                dropdownToggle.setAttribute('aria-expanded', 'false');
                dropdownToggle.style.display = '';
            }
            if (toggleAllBtn) toggleAllBtn.style.display = '';

            // Clear existing forms but keep the first person form
            const personForms = document.getElementById('personForms');
            if (personForms) {
                const firstPersonForm = personForms.querySelector('.collapsible-entity');
                personForms.innerHTML = '';
                if (firstPersonForm) {
                    personForms.appendChild(firstPersonForm);
                }
            }

            // Show all form containers
            const businessFormContainer = document.getElementById('businessFormContainer');
            const addRepresentativeContainer = document.getElementById('addRepresentativeContainer');
            const representativeForms = document.getElementById('representativeForms');
            const representativeSectionContainer = document.getElementById('representativeSectionContainer');

            if (businessFormContainer) businessFormContainer.style.display = 'block';
            if (addRepresentativeContainer) addRepresentativeContainer.style.display = 'block';
            if (representativeForms) representativeForms.style.display = '';
            if (representativeSectionContainer) representativeSectionContainer.style.display = '';

            // Hide all status messages
            document.querySelectorAll('.status-message').forEach(msg => {
                if (msg) msg.style.display = 'none';
            });

            // Process business entity first if it exists
            const businessEntity = lastSubmittedData.entities.find(e => e.entity_type === 'business');
            if (businessEntity) {
                // Show business form
                if (businessFormContainer) businessFormContainer.style.display = 'block';
                if (addRepresentativeContainer) addRepresentativeContainer.style.display = 'block';
                if (addBusinessBtn) addBusinessBtn.disabled = true;

                // Fill business form
                const businessForm = document.querySelector('.business-form');
                if (businessForm) {
                    const businessName = businessForm.querySelector('[name="business_name"]');
                    const businessType = businessForm.querySelector('[name="business_type"]');
                    const businessEin = businessForm.querySelector('[name="business_federal_ein"]');
                    const businessPhone = businessForm.querySelector('[name="business_phone_number"]');
                    const businessRegistryId = businessForm.querySelector('[name="business_registry_id"]');
                    const businessUrl = businessForm.querySelector('[name="business_url"]');
                    const businessAltName = businessForm.querySelector('[name="business_alternate_name"]');
                    const line1 = businessForm.querySelector('[name="line_1"]');
                    const city = businessForm.querySelector('[name="city"]');
                    const state = businessForm.querySelector('[name="state"]');
                    const postalCode = businessForm.querySelector('[name="postal_code"]');
                    const meta = businessForm.querySelector('[name="meta"]');

                    if (businessName) businessName.value = businessEntity.business_name || '';
                    if (businessType) businessType.value = businessEntity.business_type || '';
                    if (businessEin) businessEin.value = businessEntity.business_federal_ein || '';
                    if (businessPhone) businessPhone.value = businessEntity.business_phone_number || '';
                    if (businessRegistryId) businessRegistryId.value = businessEntity.business_registry_id || '';
                    if (businessUrl) businessUrl.value = businessEntity.business_url || '';
                    if (businessAltName) businessAltName.value = businessEntity.business_alternate_name || '';
                    if (line1) line1.value = businessEntity.addresses?.[0]?.line_1 || '';
                    if (city) city.value = businessEntity.addresses?.[0]?.city || '';
                    if (state) state.value = businessEntity.addresses?.[0]?.state || '';
                    if (postalCode) postalCode.value = businessEntity.addresses?.[0]?.postal_code || '';
                    if (meta) meta.value = JSON.stringify(businessEntity.meta || {}, null, 2);
                    // Set country dropdown
                    const businessCountrySelect = businessForm.querySelector('[name="country_code"]');
                    if (businessCountrySelect && businessEntity.addresses?.[0]?.country_code) {
                        businessCountrySelect.value = businessEntity.addresses[0].country_code;
                        businessCountrySelect.dispatchEvent(new Event('change'));
                    }
                }
            } else {
                // Hide business form and related containers if no business in previous submission
                if (businessFormContainer) businessFormContainer.style.display = 'none';
                if (addRepresentativeContainer) addRepresentativeContainer.style.display = 'none';
                if (addBusinessBtn) addBusinessBtn.disabled = false;
                // Clear any existing representative forms
                const representativeForms = document.getElementById('representativeForms');
                if (representativeForms) representativeForms.innerHTML = '';
            }

            // Process person entities
            const personEntities = lastSubmittedData.entities.filter(e => e.entity_type === 'person');
            personEntities.forEach((person, index) => {
                if (index === 0) {
                    // First person is already in the template
                    const personForm = document.querySelector('.person-form');
                    if (personForm) {
                        const nameFirst = personForm.querySelector('[name="name_first"]');
                        const nameLast = personForm.querySelector('[name="name_last"]');
                        const email = personForm.querySelector('[name="email_address"]');
                        const phone = personForm.querySelector('[name="phone_number"]');
                        const ssn = personForm.querySelector('[name="document_ssn"]');
                        const birthDate = personForm.querySelector('[name="birth_date"]');
                        const ipAddress = personForm.querySelector('[name="ip_address"]');
                        const line1 = personForm.querySelector('[name="line_1"]');
                        const city = personForm.querySelector('[name="city"]');
                        const state = personForm.querySelector('[name="state"]');
                        const postalCode = personForm.querySelector('[name="postal_code"]');
                        const meta = personForm.querySelector('[name="meta"]');

                        if (nameFirst) nameFirst.value = person.data.name_first || '';
                        if (nameLast) nameLast.value = person.data.name_last || '';
                        if (email) email.value = person.data.email_address || '';
                        if (phone) phone.value = person.data.phone_number || '';
                        if (ssn) ssn.value = person.data.document_ssn || '';
                        if (birthDate) birthDate.value = person.data.birth_date || '';
                        if (ipAddress) ipAddress.value = person.data.ip_address_v4 || '';
                        if (line1) line1.value = person.data.addresses?.[0]?.line_1 || '';
                        if (city) city.value = person.data.addresses?.[0]?.city || '';
                        if (state) state.value = person.data.addresses?.[0]?.state || '';
                        if (postalCode) postalCode.value = person.data.addresses?.[0]?.postal_code || '';
                        if (meta) meta.value = JSON.stringify(person.data.meta || {}, null, 2);
                        const personCountrySelect = personForm.querySelector('select[name="country_code"]');
                        if (personCountrySelect && person.data.addresses?.[0]?.country_code) {
                            personCountrySelect.value = person.data.addresses[0].country_code;
                            personCountrySelect.dispatchEvent(new Event('change'));
                        }
                    }
                } else {
                    // Add additional persons
                    const addPersonBtn = document.getElementById('addPersonBtn');
                    if (addPersonBtn) addPersonBtn.click();
                    const newPersonForm = document.querySelectorAll('.person-form')[index];
                    if (newPersonForm) {
                        const nameFirst = newPersonForm.querySelector('[name="name_first"]');
                        const nameLast = newPersonForm.querySelector('[name="name_last"]');
                        const email = newPersonForm.querySelector('[name="email_address"]');
                        const phone = newPersonForm.querySelector('[name="phone_number"]');
                        const ssn = newPersonForm.querySelector('[name="document_ssn"]');
                        const birthDate = newPersonForm.querySelector('[name="birth_date"]');
                        const ipAddress = newPersonForm.querySelector('[name="ip_address"]');
                        const line1 = newPersonForm.querySelector('[name="line_1"]');
                        const city = newPersonForm.querySelector('[name="city"]');
                        const state = newPersonForm.querySelector('[name="state"]');
                        const postalCode = newPersonForm.querySelector('[name="postal_code"]');
                        const meta = newPersonForm.querySelector('[name="meta"]');

                        if (nameFirst) nameFirst.value = person.data.name_first || '';
                        if (nameLast) nameLast.value = person.data.name_last || '';
                        if (email) email.value = person.data.email_address || '';
                        if (phone) phone.value = person.data.phone_number || '';
                        if (ssn) ssn.value = person.data.document_ssn || '';
                        if (birthDate) birthDate.value = person.data.birth_date || '';
                        if (ipAddress) ipAddress.value = person.data.ip_address_v4 || '';
                        if (line1) line1.value = person.data.addresses?.[0]?.line_1 || '';
                        if (city) city.value = person.data.addresses?.[0]?.city || '';
                        if (state) state.value = person.data.addresses?.[0]?.state || '';
                        if (postalCode) postalCode.value = person.data.addresses?.[0]?.postal_code || '';
                        if (meta) meta.value = JSON.stringify(person.data.meta || {}, null, 2);
                        const personCountrySelect = newPersonForm.querySelector('select[name="country_code"]');
                        if (personCountrySelect && person.data.addresses?.[0]?.country_code) {
                            personCountrySelect.value = person.data.addresses[0].country_code;
                            personCountrySelect.dispatchEvent(new Event('change'));
                        }
                    }
                }
            });

            // Show all collapsible entities
            document.querySelectorAll('.collapsible-entity').forEach(entity => {
                if (entity) {
                    entity.style.display = '';
                    const body = entity.querySelector('.collapsible-body');
                    const toggleBtn = entity.querySelector('.btn-toggle-entity');
                    const icon = toggleBtn.querySelector('i');
                    if (body && toggleBtn && icon) {
                        body.classList.add('show');
                        toggleBtn.setAttribute('aria-expanded', 'true');
                        icon.classList.add('fa-chevron-down');
                        icon.classList.remove('fa-chevron-right');
                    }
                }
            });

            showNotification('Previous application data has been restored', 'success');
        }


        // --- FAB Dashboard Links ---
        // Move these functions to global scope
        function renderFabLinks() {
            const fabLinksList = document.getElementById('fabLinksList');
            if (!fabLinksList) return;
            // Get filter values
            const searchValue = (document.getElementById('fabSearchInput')?.value || '').toLowerCase();
            const statusValue = document.getElementById('fabStatusFilter')?.value || '';
            fabLinksList.innerHTML = '';
            let links = (window.applicationLinks || []).slice().reverse();
            // Filter by search
            if (searchValue) {
                links = links.filter(link => {
                    // Business name
                    let businessName = '';
                    if (link.data && Array.isArray(link.data.entities)) {
                        const businessEntity = link.data.entities.find(e => e.entity_type === 'business');
                        if (businessEntity && businessEntity.business_name) {
                            businessName = businessEntity.business_name;
                        }
                    }
                    // Person 1 name
                    const name = link.person1 && (link.person1.first || link.person1.last)
                        ? `${link.person1.first} ${link.person1.last}`.trim()
                        : '';
                    return (
                        (businessName && businessName.toLowerCase().includes(searchValue)) ||
                        (name && name.toLowerCase().includes(searchValue))
                    );
                });
            }
            // Filter by status
            if (statusValue) {
                links = links.filter(link => {
                    if (statusValue === "Manual Review") {
                        return (
                            link.status === "Manual Review" ||
                            link.status === "waiting_review" ||
                            link.status === "Application Review" ||
                            link.journey_application_status === "Manual Review" ||
                            link.journey_application_status === "waiting_review" ||
                            link.journey_application_status === "Application Review"
                        );
                    }
                    return link.status === statusValue;
                });
            }
            // Sort by submittedAt (newest first)
            links.sort((a, b) => {
                const dateA = new Date(a.submittedAt || a.data?.submittedAt || 0);
                const dateB = new Date(b.submittedAt || b.data?.submittedAt || 0);
                return dateB - dateA;
            });
            if (links.length === 0) {
                const li = document.createElement('li');
                li.className = 'list-group-item text-muted';
                li.textContent = 'No recent applications.';
                fabLinksList.appendChild(li);
                return;
            }
            links.forEach((link, idx) => {
                const li = document.createElement('li');
                li.className = 'list-group-item d-flex flex-column align-items-start';
                // Format date/time
                let submitted = '';
                if (link.submittedAt) {
                    try {
                        const d = new Date(link.submittedAt);
                        submitted = d.toLocaleString(undefined, { dateStyle: 'medium', timeStyle: 'short' });
                    } catch {}
                }
                // Check for business entity
                let businessName = '';
                let businessType = '';
                let numReps = 0;
                if (link.data && Array.isArray(link.data.entities)) {
                    const businessEntity = link.data.entities.find(e => e.entity_type === 'business');
                    if (businessEntity) {
                        businessName = businessEntity.business_name || '';
                        businessType = businessEntity.business_type || '';
                        if (Array.isArray(businessEntity.representatives)) {
                            numReps = businessEntity.representatives.length;
                        }
                    }
                }
                // Person entities
                let numPeople = 0;
                if (link.data && Array.isArray(link.data.entities)) {
                    numPeople = link.data.entities.filter(e => e.entity_type === 'person').length;
                }
                // Person 1 name fallback
                const name = link.person1 && (link.person1.first || link.person1.last)
                    ? `${link.person1.first} ${link.person1.last}`.trim()
                    : '';
                // Status badge
                let status = link.status || '';
                let statusClass = 'bg-secondary';
                if (status === 'Approved') statusClass = 'bg-success';
                else if (status === 'Denied') statusClass = 'bg-danger';
                else if (status === 'Manual Review') statusClass = 'bg-warning text-dark';
                else if (status === 'Pending') statusClass = 'bg-info text-dark';
                let mainLabel = '';
                if (businessName) {
                    mainLabel = `<span class='ms-2'><i class='fas fa-building'></i> ${businessName}</span>`;
                } else if (name) {
                    mainLabel = `<span class='ms-2'><i class='fas fa-user'></i> ${name}</span>`;
                }
                // Details row
                let details = '';
                if (numPeople > 0) {
                    details += `<span class=\"badge bg-secondary me-1\" title=\"Persons\"><i class=\"fas fa-user\"></i> ${numPeople}</span>`;
                }
                if (numReps > 0) {
                    details += `<span class=\"badge bg-info text-dark me-1\" title=\"Representatives\"><i class=\"fas fa-user-tie\"></i> ${numReps}</span>`;
                }
                if (submitted) {
                    details += `<span class="badge bg-light text-dark me-1"><i class="far fa-clock"></i> ${submitted}</span>`;
                }
                // Find the original index in window.applicationLinks
                const originalIdx = window.applicationLinks.findIndex(app => app.submittedAt === link.submittedAt && app.jaToken === link.jaToken);
                li.innerHTML = `
                    <div class="d-flex w-100 justify-content-between align-items-center">
                        <div style="margin-right: 1rem;">
                            ${mainLabel}
                            <span class="badge ${statusClass} ms-2">${status || 'Unknown'}</span>
                            <div class="mt-1">${details}</div>
                        </div>
                        <div class="d-flex gap-1">
                            <a href="${link.url}" target="_blank" class="btn btn-sm btn-outline-primary px-2" style="min-width: 70px;"><i class="fas fa-external-link-alt"></i> Open</a>
                            <button class="btn btn-sm btn-outline-primary px-2 fab-rerun-btn" data-app-idx="${originalIdx}" style="min-width: 70px;"><i class="fas fa-redo"></i> Re-run</button>
                        </div>
                    </div>
                `;
                fabLinksList.appendChild(li);
            });
            // Attach re-run handlers
            fabLinksList.querySelectorAll('.fab-rerun-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    const idx = parseInt(this.getAttribute('data-app-idx'));
                    const app = window.applicationLinks[idx];
                    if (app && app.data) {
                        rerunSpecificApp(app.data);
                    }
                });
            });
        }
        function setupFabFilterControls() {
            const searchInput = document.getElementById('fabSearchInput');
            const statusFilter = document.getElementById('fabStatusFilter');
            if (searchInput) {
                searchInput.removeEventListener('input', renderFabLinks);
                searchInput.addEventListener('input', renderFabLinks);
            }
            if (statusFilter) {
                statusFilter.removeEventListener('change', renderFabLinks);
                statusFilter.addEventListener('change', renderFabLinks);
            }
        }
        function showFabPopover() {
            const fabPopover = document.getElementById('dashboardLinksPopover');
            fabPopover.style.display = 'block';
            fabPopover.focus();
            setupFabFilterControls(); // Attach listeners every time popover is shown
            renderFabLinks(); // Render with current filter values
        }
        function hideFabPopover() {
            const fabPopover = document.getElementById('dashboardLinksPopover');
            fabPopover.style.display = 'none';
        }
        document.addEventListener('DOMContentLoaded', function() {
            const fabBtn = document.getElementById('dashboardLinksFab');
            const fabPopover = document.getElementById('dashboardLinksPopover');
            const fabLinksList = document.getElementById('fabLinksList');
            const closeFabPopover = document.getElementById('closeFabPopover');
            if (fabBtn) {
                fabBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    if (fabPopover.style.display === 'block') {
                        hideFabPopover();
                    } else {
                        showFabPopover();
                    }
                });
            }
            if (closeFabPopover) {
                closeFabPopover.addEventListener('click', function(e) {
                    e.stopPropagation();
                    hideFabPopover();
                });
            }
            // Hide popover when clicking outside
            document.addEventListener('mousedown', function(e) {
                if (fabPopover.style.display === 'block' && !fabPopover.contains(e.target) && e.target !== fabBtn) {
                    hideFabPopover();
                }
            });
            // Hide on Escape
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && fabPopover.style.display === 'block') {
                    hideFabPopover();
                }
            });
        });

        // Load application links from electron-store on page load
        document.addEventListener('DOMContentLoaded', async function () {
            const fabBtn = document.getElementById('dashboardLinksFab');
            const fabPopover = document.getElementById('dashboardLinksPopover');
            const fabLinksList = document.getElementById('fabLinksList');
            const closeFabPopover = document.getElementById('closeFabPopover');

            // Load application history from electron-store
            try {
                const history = await window.api.getApplicationHistory();
                window.applicationLinks = Array.isArray(history) ? history.reverse() : [];
                renderFabLinks();

                // Set lastSubmittedData to the most recent application
                if (window.applicationLinks && window.applicationLinks.length > 0) {
                    const mostRecent = window.applicationLinks[0];
                    if (mostRecent && mostRecent.data) {
                        lastSubmittedData = JSON.parse(JSON.stringify(mostRecent.data));
                    }
                }
            } catch (e) {
                window.applicationLinks = [];
                console.error('Failed to load application links from electron-store', e);
            }

        });

        // Function to re-run a specific application from stored data
        function rerunSpecificApp(appData) {
            if (!appData) return;
            // Set lastSubmittedData for developer mode
            lastSubmittedData = JSON.parse(JSON.stringify(appData));
            // Restore the form and re-submit using the stored data
            // This is similar to rerunLastApp, but uses the provided appData
            // Reset the UI state
            const addPersonBtn = document.getElementById('addPersonBtn');
            const addBusinessBtn = document.getElementById('addBusinessBtn');
            const addRepresentativeBtn = document.getElementById('addRepresentativeBtn');
            const prefillBtn = document.getElementById('prefillBtn');
            const submitBtn = document.getElementById('submitBtn');
            const actionRow = document.getElementById('actionRow');
            const mb4 = document.querySelector('.mb-4');
            const dropdownMenu = document.querySelector('.dropdown-menu');
            const dropdownToggle = document.querySelector('.dropdown-toggle');
            const toggleAllBtn = document.getElementById('toggleAllEntitiesBtn');

            // Show all buttons and containers
            if (addPersonBtn) addPersonBtn.style.display = '';
            if (addBusinessBtn) addBusinessBtn.style.display = '';
            if (addRepresentativeBtn) addRepresentativeBtn.style.display = '';
            if (prefillBtn) prefillBtn.style.display = '';
            if (submitBtn) submitBtn.style.display = '';
            if (actionRow) actionRow.style.display = '';
            if (mb4) mb4.style.display = '';
            if (dropdownMenu) {
                dropdownMenu.classList.remove('show');
                dropdownMenu.style.display = '';
            }
            if (dropdownToggle) {
                dropdownToggle.setAttribute('aria-expanded', 'false');
                dropdownToggle.style.display = '';
            }
            if (toggleAllBtn) toggleAllBtn.style.display = '';

            // Clear existing forms but keep the first person form
            const personForms = document.getElementById('personForms');
            if (personForms) {
                const firstPersonForm = personForms.querySelector('.collapsible-entity');
                personForms.innerHTML = '';
                if (firstPersonForm) {
                    personForms.appendChild(firstPersonForm);
                }
            }

            // Show all form containers
            const businessFormContainer = document.getElementById('businessFormContainer');
            const addRepresentativeContainer = document.getElementById('addRepresentativeContainer');
            const representativeForms = document.getElementById('representativeForms');
            const representativeSectionContainer = document.getElementById('representativeSectionContainer');

            if (businessFormContainer) businessFormContainer.style.display = 'block';
            if (addRepresentativeContainer) addRepresentativeContainer.style.display = 'block';
            if (representativeForms) representativeForms.style.display = '';
            if (representativeSectionContainer) representativeSectionContainer.style.display = '';

            // Hide all status messages
            document.querySelectorAll('.status-message').forEach(msg => {
                if (msg) msg.style.display = 'none';
            });

            // Process business entity first if it exists
            const businessEntity = appData.entities.find(e => e.entity_type === 'business');
            if (businessEntity) {
                // Show business form
                if (businessFormContainer) businessFormContainer.style.display = 'block';
                if (addRepresentativeContainer) addRepresentativeContainer.style.display = 'block';
                if (addBusinessBtn) addBusinessBtn.disabled = true;

                // Fill business form
                const businessForm = document.querySelector('.business-form');
                if (businessForm) {
                    const businessName = businessForm.querySelector('[name="business_name"]');
                    const businessType = businessForm.querySelector('[name="business_type"]');
                    const businessEin = businessForm.querySelector('[name="business_federal_ein"]');
                    const businessPhone = businessForm.querySelector('[name="business_phone_number"]');
                    const businessRegistryId = businessForm.querySelector('[name="business_registry_id"]');
                    const businessUrl = businessForm.querySelector('[name="business_url"]');
                    const businessAltName = businessForm.querySelector('[name="business_alternate_name"]');
                    const line1 = businessForm.querySelector('[name="line_1"]');
                    const city = businessForm.querySelector('[name="city"]');
                    const state = businessForm.querySelector('[name="state"]');
                    const postalCode = businessForm.querySelector('[name="postal_code"]');
                    const meta = businessForm.querySelector('[name="meta"]');

                    if (businessName) businessName.value = businessEntity.business_name || '';
                    if (businessType) businessType.value = businessEntity.business_type || '';
                    if (businessEin) businessEin.value = businessEntity.business_federal_ein || '';
                    if (businessPhone) businessPhone.value = businessEntity.business_phone_number || '';
                    if (businessRegistryId) businessRegistryId.value = businessEntity.business_registry_id || '';
                    if (businessUrl) businessUrl.value = businessEntity.business_url || '';
                    if (businessAltName) businessAltName.value = businessEntity.business_alternate_name || '';
                    if (line1) line1.value = businessEntity.addresses?.[0]?.line_1 || '';
                    if (city) city.value = businessEntity.addresses?.[0]?.city || '';
                    if (state) state.value = businessEntity.addresses?.[0]?.state || '';
                    if (postalCode) postalCode.value = businessEntity.addresses?.[0]?.postal_code || '';
                    if (meta) meta.value = JSON.stringify(businessEntity.meta || {}, null, 2);

                    // Add representatives
                    if (businessEntity.representatives) {
                        businessEntity.representatives.forEach((rep, index) => {
                            if (index === 0) {
                                // First representative is already in the template
                                const repForm = document.querySelector('.representative-form');
                                if (repForm) {
                                    repForm.querySelector('[name="name_first"]').value = rep.name_first || '';
                                    repForm.querySelector('[name="name_last"]').value = rep.name_last || '';
                                    repForm.querySelector('[name="email_address"]').value = rep.email_address || '';
                                    repForm.querySelector('[name="phone_number"]').value = rep.phone_number || '';
                                    repForm.querySelector('[name="document_ssn"]').value = rep.document_ssn || '';
                                    repForm.querySelector('[name="birth_date"]').value = rep.birth_date || '';
                                    repForm.querySelector('[name="line_1"]').value = rep.addresses?.[0]?.line_1 || '';
                                    repForm.querySelector('[name="city"]').value = rep.addresses?.[0]?.city || '';
                                    repForm.querySelector('[name="state"]').value = rep.addresses?.[0]?.state || '';
                                    repForm.querySelector('[name="postal_code"]').value = rep.addresses?.[0]?.postal_code || '';
                                    repForm.querySelector('[name="meta"]').value = JSON.stringify(rep.meta || {}, null, 2);
                                    // Set country dropdown
                                    const countrySelect = repForm.querySelector('[name="country_code"]');
                                    if (countrySelect && rep.addresses?.[0]?.country_code) {
                                        countrySelect.value = rep.addresses[0].country_code;
                                        countrySelect.dispatchEvent(new Event('change'));
                                    }
                                }
                            } else {
                                // Add additional representatives
                                const addRepBtn = document.getElementById('addRepresentativeBtn');
                                if (addRepBtn) addRepBtn.click();
                                const newRepForm = document.querySelectorAll('.representative-form')[index];
                                if (newRepForm) {
                                    newRepForm.querySelector('[name="name_first"]').value = rep.name_first || '';
                                    newRepForm.querySelector('[name="name_last"]').value = rep.name_last || '';
                                    newRepForm.querySelector('[name="email_address"]').value = rep.email_address || '';
                                    newRepForm.querySelector('[name="phone_number"]').value = rep.phone_number || '';
                                    newRepForm.querySelector('[name="document_ssn"]').value = rep.document_ssn || '';
                                    newRepForm.querySelector('[name="birth_date"]').value = rep.birth_date || '';
                                    newRepForm.querySelector('[name="line_1"]').value = rep.addresses?.[0]?.line_1 || '';
                                    newRepForm.querySelector('[name="city"]').value = rep.addresses?.[0]?.city || '';
                                    newRepForm.querySelector('[name="state"]').value = rep.addresses?.[0]?.state || '';
                                    newRepForm.querySelector('[name="postal_code"]').value = rep.addresses?.[0]?.postal_code || '';
                                    newRepForm.querySelector('[name="meta"]').value = JSON.stringify(rep.meta || {}, null, 2);
                                    // Set country dropdown
                                    const countrySelect = newRepForm.querySelector('[name="country_code"]');
                                    if (countrySelect && rep.addresses?.[0]?.country_code) {
                                        countrySelect.value = rep.addresses[0].country_code;
                                        countrySelect.dispatchEvent(new Event('change'));
                                    }
                                }
                            }
                        });
                    }
                }
            } else {
                // Hide business form and related containers if no business in previous submission
                if (businessFormContainer) businessFormContainer.style.display = 'none';
                if (addRepresentativeContainer) addRepresentativeContainer.style.display = 'none';
                if (addBusinessBtn) addBusinessBtn.disabled = false;
                // Clear any existing representative forms
                const representativeForms = document.getElementById('representativeForms');
                if (representativeForms) representativeForms.innerHTML = '';
            }

            // Process person entities
            const personEntities = appData.entities.filter(e => e.entity_type === 'person');
            personEntities.forEach((person, index) => {
                if (index === 0) {
                    // First person is already in the template
                    const personForm = document.querySelector('.person-form');
                    if (personForm) {
                        const nameFirst = personForm.querySelector('[name="name_first"]');
                        const nameLast = personForm.querySelector('[name="name_last"]');
                        const email = personForm.querySelector('[name="email_address"]');
                        const phone = personForm.querySelector('[name="phone_number"]');
                        const ssn = personForm.querySelector('[name="document_ssn"]');
                        const birthDate = personForm.querySelector('[name="birth_date"]');
                        const ipAddress = personForm.querySelector('[name="ip_address"]');
                        const line1 = personForm.querySelector('[name="line_1"]');
                        const city = personForm.querySelector('[name="city"]');
                        const state = personForm.querySelector('[name="state"]');
                        const postalCode = personForm.querySelector('[name="postal_code"]');
                        const meta = personForm.querySelector('[name="meta"]');

                        if (nameFirst) nameFirst.value = person.data.name_first || '';
                        if (nameLast) nameLast.value = person.data.name_last || '';
                        if (email) email.value = person.data.email_address || '';
                        if (phone) phone.value = person.data.phone_number || '';
                        if (ssn) ssn.value = person.data.document_ssn || '';
                        if (birthDate) birthDate.value = person.data.birth_date || '';
                        if (ipAddress) ipAddress.value = person.data.ip_address_v4 || '';
                        if (line1) line1.value = person.data.addresses?.[0]?.line_1 || '';
                        if (city) city.value = person.data.addresses?.[0]?.city || '';
                        if (state) state.value = person.data.addresses?.[0]?.state || '';
                        if (postalCode) postalCode.value = person.data.addresses?.[0]?.postal_code || '';
                        if (meta) meta.value = JSON.stringify(person.data.meta || {}, null, 2);
                        const personCountrySelect = personForm.querySelector('select[name="country_code"]');
                        if (personCountrySelect && person.data.addresses?.[0]?.country_code) {
                            personCountrySelect.value = person.data.addresses[0].country_code;
                            personCountrySelect.dispatchEvent(new Event('change'));
                        }
                    }
                } else {
                    // Add additional persons
                    const addPersonBtn = document.getElementById('addPersonBtn');
                    if (addPersonBtn) addPersonBtn.click();
                    const newPersonForm = document.querySelectorAll('.person-form')[index];
                    if (newPersonForm) {
                        const nameFirst = newPersonForm.querySelector('[name="name_first"]');
                        const nameLast = newPersonForm.querySelector('[name="name_last"]');
                        const email = newPersonForm.querySelector('[name="email_address"]');
                        const phone = newPersonForm.querySelector('[name="phone_number"]');
                        const ssn = newPersonForm.querySelector('[name="document_ssn"]');
                        const birthDate = newPersonForm.querySelector('[name="birth_date"]');
                        const ipAddress = newPersonForm.querySelector('[name="ip_address"]');
                        const line1 = newPersonForm.querySelector('[name="line_1"]');
                        const city = newPersonForm.querySelector('[name="city"]');
                        const state = newPersonForm.querySelector('[name="state"]');
                        const postalCode = newPersonForm.querySelector('[name="postal_code"]');
                        const meta = newPersonForm.querySelector('[name="meta"]');

                        if (nameFirst) nameFirst.value = person.data.name_first || '';
                        if (nameLast) nameLast.value = person.data.name_last || '';
                        if (email) email.value = person.data.email_address || '';
                        if (phone) phone.value = person.data.phone_number || '';
                        if (ssn) ssn.value = person.data.document_ssn || '';
                        if (birthDate) birthDate.value = person.data.birth_date || '';
                        if (ipAddress) ipAddress.value = person.data.ip_address_v4 || '';
                        if (line1) line1.value = person.data.addresses?.[0]?.line_1 || '';
                        if (city) city.value = person.data.addresses?.[0]?.city || '';
                        if (state) state.value = person.data.addresses?.[0]?.state || '';
                        if (postalCode) postalCode.value = person.data.addresses?.[0]?.postal_code || '';
                        if (meta) meta.value = JSON.stringify(person.data.meta || {}, null, 2);
                        const personCountrySelect = newPersonForm.querySelector('select[name="country_code"]');
                        if (personCountrySelect && person.data.addresses?.[0]?.country_code) {
                            personCountrySelect.value = person.data.addresses[0].country_code;
                            personCountrySelect.dispatchEvent(new Event('change'));
                        }
                    }
                }
            });

            // Show all collapsible entities
            document.querySelectorAll('.collapsible-entity').forEach(entity => {
                if (entity) {
                    entity.style.display = '';
                    const body = entity.querySelector('.collapsible-body');
                    const toggleBtn = entity.querySelector('.btn-toggle-entity');
                    const icon = toggleBtn.querySelector('i');
                    if (body && toggleBtn && icon) {
                        body.classList.add('show');
                        toggleBtn.setAttribute('aria-expanded', 'true');
                        icon.classList.add('fa-chevron-down');
                        icon.classList.remove('fa-chevron-right');
                    }
                }
            });

            showNotification('Previous application data has been restored', 'success');
        }

        // Add event listener for 'Run another application' button
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.run-another-app-btn').forEach(function(btn) {
                btn.addEventListener('click', function() {
                    window.location.reload();
                });
            });
        });

        // Early config check: redirect to config.html if config is missing or invalid
        fetch('/api/config')
          .then(res => {
            if (!res.ok) {
              window.location.href = '/config.html';
              return Promise.reject();
            }
            return res.json();
          })
          .then(config => {
            console.log('Config from /api/config:', config);
            if (!config || !config.ALLOY_SDK_KEY || !config.ALLOY_JOURNEY_TOKEN || !config.ALLOY_TOKEN || !config.ALLOY_SECRET || !config.ALLOY_BASE_URL) {
              window.location.href = '/config.html';
            }
          })
          .catch(() => {
            window.location.href = '/config.html';
          });

        document.addEventListener('keydown', async function(e) {
            // Command+Shift+X (or Ctrl+Shift+X on Windows/Linux)
            if ((e.metaKey || e.ctrlKey) && e.shiftKey && e.key.toLowerCase() === 'x') {
                e.preventDefault();
                await window.api.clearConfig();
                window.location.reload();
            }
            // 
        });

        // In your form submission code, add this helper function
        function formatPhoneToE164(phone) {
            // Remove all non-numeric characters
            let cleaned = phone.replace(/\D/g, '');
            
            // If US/Canada number (assuming 10 digits)
            if (cleaned.length === 10) {
                return `+1${cleaned}`;
            }
            
            // If number already has country code (starts with +)
            if (phone.startsWith('+')) {
                return phone;
            }
            
            // Default case: add +1 if no country code
            return `+${cleaned}`;
        }

        // --- Custom Profiles Logic ---
        let customProfiles = [];
        let editingProfileIndex = null;
        let customProfileSaveInProgress = false;

        function getPersonFormTemplate() {
            // Use the first .person-form as the template
            const personForm = document.querySelector('.person-form');
            if (!personForm) return null;
            const clone = personForm.closest('.collapsible-entity').cloneNode(true);
            // Remove any validation/error states and reset values
            clone.querySelectorAll('input, select, textarea').forEach(field => {
                field.value = '';
                field.classList.remove('is-invalid');
                field.removeAttribute('aria-invalid');
                if (typeof field.setCustomValidity === 'function') {
                    field.setCustomValidity('');
                }
            });
            // Remove any person-specific labels
            const header = clone.querySelector('h3');
            if (header) header.textContent = '';
            // Remove delete/collapse buttons
            clone.querySelectorAll('.delete-person, .btn-toggle-entity').forEach(btn => btn.style.display = 'none');
            // Remove collapse logic
            clone.querySelectorAll('.collapsible-header, .collapsible-body').forEach(el => el.classList.remove('collapsible-header', 'collapsible-body', 'show'));
            // Get the form
            const form = clone.querySelector('form');
            if (form) {
                // Insert Profile Name and Description fields at the top
                const profileRow = document.createElement('div');
                profileRow.className = 'row mb-2';
                profileRow.innerHTML = `
                    <div class="col-md-6 mb-2">
                        <label class="form-label">Profile Name <span style="color:red">*</span></label>
                        <input type="text" class="form-control" name="name" required>
                    </div>
                    <div class="col-md-6 mb-2">
                        <label class="form-label">Description</label>
                        <input type="text" class="form-control" name="description">
                    </div>
                `;
                form.insertBefore(profileRow, form.firstChild);
            }
            return form;
        }

        function openCustomProfileModal(mode, idx = null) {
            const modal = document.getElementById('customProfileModal');
            const modalBody = document.getElementById('customProfileModalBody');
            modalBody.innerHTML = '';
            const title = document.getElementById('customProfileModalTitle');
            let form = getPersonFormTemplate();
            let fakerBtn;
            if (form) {
                form.id = 'customProfileForm';
                // Remove old faker button if present
                const oldFakerBtn = document.getElementById('customProfileFakerBtn');
                if (oldFakerBtn) oldFakerBtn.remove();
                // Create the faker button
                fakerBtn = document.createElement('button');
                fakerBtn.type = 'button';
                fakerBtn.className = 'btn btn-outline-secondary me-2'; // Add right margin
                fakerBtn.id = 'customProfileFakerBtn';
                fakerBtn.innerHTML = '<i class="fas fa-magic"></i> Fill with Fake data';
                // Helper to update button label
                function updateFakerBtnLabel() {
                    const anyFilled = Array.from(form.elements).some(el => el.name && el.type !== 'button' && el.value.trim());
                    fakerBtn.innerHTML = `<i class="fas fa-magic"></i> ${anyFilled ? 'Fill remaining fields with Fake data' : 'Fill with Fake data'}`;
                }
                // Update label on input
                form.addEventListener('input', updateFakerBtnLabel);
                // Fill logic
                fakerBtn.onclick = function(e) {
                    e.preventDefault();
                    if (typeof window.fakerUtils === 'undefined' || typeof window.fakerUtils.generateSampleData !== 'function') {
                        showNotification('Faker utils are not available', 'error');
                        return;
                    }
                    const data = window.fakerUtils.generateSampleData();
                    // Fill all fields if none are filled, else only fill empty fields
                    Array.from(form.elements).forEach(el => {
                        if (!el.name || el.type === 'button') return;
                        if (el.name === 'name' || el.name === 'description') return; // Don't fill profile name/desc
                        if (!el.value.trim()) {
                            if (el.name === 'name_first') el.value = data.firstName;
                            else if (el.name === 'name_last') el.value = data.lastName;
                            else if (el.name === 'email_address') el.value = data.email;
                            else if (el.name === 'phone_number') el.value = data.phone;
                            else if (el.name === 'document_ssn') el.value = data.ssn;
                            else if (el.name === 'birth_date') el.value = data.birthDate;
                            else if (el.name === 'ip_address') el.value = data.ipAddress;
                            else if (el.name === 'line_1') el.value = data.streetAddress;
                            else if (el.name === 'city') el.value = data.city;
                            else if (el.name === 'state') el.value = data.state;
                            else if (el.name === 'postal_code') el.value = data.zipCode;
                            else if (el.name === 'country_code') el.value = 'US';
                        }
                    });
                    // Trigger change event for country dropdown
                    const countrySelect = form.querySelector('select[name="country_code"]');
                    if (countrySelect) {
                        countrySelect.dispatchEvent(new Event('change'));
                    }
                    updateFakerBtnLabel();
                };
                // Insert the form into the modal body
                modalBody.appendChild(form);
                // Move the faker button to the modal footer, left of Cancel
                const modalFooter = modal.querySelector('.modal-footer');
                if (modalFooter) {
                    modalFooter.insertBefore(fakerBtn, modalFooter.querySelector('#cancelCustomProfile'));
                }
                // Initial label (after possible edit population)
                setTimeout(() => updateFakerBtnLabel(), 0);
            }
            if (mode === 'edit' && idx !== null) {
                editingProfileIndex = idx;
                title.textContent = 'Edit Custom Profile';
                const profile = customProfiles[idx];
                Object.keys(profile).forEach(key => {
                    if (form && form.elements[key]) form.elements[key].value = profile[key];
                });
                // Update faker button label after fields are populated
                if (fakerBtn) setTimeout(() => {
                    const anyFilled = Array.from(form.elements).some(el => el.name && el.type !== 'button' && el.value.trim());
                    fakerBtn.innerHTML = `<i class="fas fa-magic"></i> ${anyFilled ? 'Fill remaining fields with Fake data' : 'Fill with Fake data'}`;
                }, 0);
            } else {
                editingProfileIndex = null;
                title.textContent = 'Add Custom Profile';
                if (form) form.reset();
                // Update faker button label for new form
                if (fakerBtn) setTimeout(() => {
                    fakerBtn.innerHTML = '<i class="fas fa-magic"></i> Fill with Fake data';
                }, 0);
            }
            modal.style.display = 'flex';
        }

        document.getElementById('addCustomProfileBtn').addEventListener('click', () => openCustomProfileModal('add'));
        document.getElementById('cancelCustomProfile').addEventListener('click', () => {
            document.getElementById('customProfileModal').style.display = 'none';
            document.getElementById('customProfileModalBody').innerHTML = '';
        });

        document.addEventListener('DOMContentLoaded', function() {
            const saveBtn = document.getElementById('saveCustomProfile');
            if (saveBtn) {
                saveBtn.addEventListener('click', async () => {
                    if (customProfileSaveInProgress) return;
                    customProfileSaveInProgress = true;
                    try {
                        const form = document.getElementById('customProfileForm');
                        if (!form) return;
                        // Validate Profile Name
                        const profileNameInput = form.querySelector('input[name="name"]');
                        if (!profileNameInput.value.trim()) {
                            profileNameInput.classList.add('is-invalid');
                            profileNameInput.focus();
                            customProfileSaveInProgress = false;
                            return;
                        } else {
                            profileNameInput.classList.remove('is-invalid');
                        }
                        if (typeof validateFormFields === 'function' && !validateFormFields(form)) {
                            customProfileSaveInProgress = false;
                            return;
                        }
                        const data = {};
                        Array.from(form.elements).forEach(el => {
                            if (el.name) data[el.name] = el.value;
                        });
                        if (editingProfileIndex !== null) {
                            customProfiles[editingProfileIndex] = data;
                        } else {
                            customProfiles.push(data);
                        }
                        await saveCustomProfiles();
                        document.getElementById('customProfileModal').style.display = 'none';
                        document.getElementById('customProfileModalBody').innerHTML = '';
                        renderCustomProfilesList(document.getElementById('profileSearch').value);
                    } finally {
                        customProfileSaveInProgress = false;
                    }
                });
            }
        });

    function enforceDateInput(e) {
        if (e.target && e.target.name === 'birth_date') {
            // Remove all non-digits
            let raw = e.target.value.replace(/[^0-9]/g, '');

            // Only allow up to 8 digits (YYYYMMDD)
            raw = raw.slice(0, 8);

            // Split into year, month, day
            let year = raw.slice(0, 4);
            let month = raw.slice(4, 6);
            let day = raw.slice(6, 8);

            // Clamp year to current year if 4 digits
            const currentYear = new Date().getFullYear();
            if (year && year.length === 4) {
                let yyyy = parseInt(year, 10);
                if (yyyy > currentYear) yyyy = currentYear;
                if (yyyy < 1) yyyy = 1;
                year = yyyy.toString().padStart(4, '0');
            }

            // Clamp month and day only if 2 digits
            if (month && month.length === 2) {
                let mm = parseInt(month, 10);
                if (mm > 12) mm = 12;
                if (mm < 1) mm = 1;
                month = mm.toString().padStart(2, '0');
            }
            if (day && day.length === 2) {
                let dd = parseInt(day, 10);
                if (dd > 31) dd = 31;
                if (dd < 1) dd = 1;
                day = dd.toString().padStart(2, '0');
            }

            // Build formatted string: YYYY-MM-DD
            let formatted = year;
            if (month) formatted += '-' + month;
            if (day) formatted += '-' + day;

            e.target.value = formatted;

            // Validate format: yyyy-MM-dd and check for real date
            if (formatted.length === 10) {
                const datePattern = /^\d{4}-\d{2}-\d{2}$/;
                if (!datePattern.test(formatted)) {
                    e.target.classList.add('is-invalid');
                } else {
                    // Check if valid date
                    const d = new Date(formatted);
                    if (
                        isNaN(d.getTime()) ||
                        d.getFullYear() !== parseInt(year, 10) ||
                        (d.getMonth() + 1) !== parseInt(month, 10) ||
                        d.getDate() !== parseInt(day, 10)
                    ) {
                        e.target.classList.add('is-invalid');
                    } else {
                        e.target.classList.remove('is-invalid');
                    }
                }
            } else {
                e.target.classList.remove('is-invalid');
            }
        }
    }

    // Attach the handler globally (only once, outside any function)
    document.addEventListener('input', enforceDateInput, true);
    document.addEventListener('change', enforceDateInput, true);

    
        async function saveCustomProfiles() {
            if (window.api && window.api.saveCustomProfiles) {
                await window.api.saveCustomProfiles(customProfiles);
            } else {
                localStorage.setItem('customProfiles', JSON.stringify(customProfiles));
            }
        }
        // Restore missing function for rendering custom profiles list
        function renderCustomProfilesList(searchTerm = '') {
            const list = document.getElementById('customProfilesList');
            list.innerHTML = '';
            const filtered = customProfiles.filter(profile =>
                profile.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                (profile.description || '').toLowerCase().includes(searchTerm.toLowerCase())
            );
            if (filtered.length === 0) {
                list.innerHTML = '<div class="text-muted">No custom profiles.</div>';
                return;
            }
            filtered.forEach((profile, idx) => {
                const item = document.createElement('div');
                item.className = 'dropdown-item mb-2 d-flex justify-content-between align-items-center';
                item.innerHTML = `
                    <div>
                        <strong>${profile.name}</strong><br>
                        <small class="text-muted">${profile.description || ''}</small>
                    </div>
                    <div>
                        <button class="btn btn-sm btn-outline-primary me-1" data-edit="${idx}"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-outline-danger" data-delete="${idx}"><i class="fas fa-trash"></i></button>
                    </div>
                `;
                // Apply profile on click (not on edit/delete)
                item.addEventListener('click', (e) => {
                    if (e.target.closest('button')) return;
                    showApplyCustomProfileModal(profile);
                });
                // Edit
                item.querySelector('[data-edit]').addEventListener('click', (e) => {
                    e.stopPropagation();
                    openCustomProfileModal('edit', idx);
                });
                // Delete (use in-app confirm)
                item.querySelector('[data-delete]').addEventListener('click', async (e) => {
                    e.stopPropagation();
                    const confirmed = await inAppConfirm('Delete this custom profile?', 'Delete Custom Profile');
                    if (confirmed) {
                        customProfiles.splice(idx, 1);
                        saveCustomProfiles();
                        renderCustomProfilesList(document.getElementById('profileSearch').value);
                    }
                });
                list.appendChild(item);
            });
        }

        // Ensure custom profiles are loaded and rendered on page load
        // Add this DOMContentLoaded handler near the top of the custom profiles logic
        // (before any UI that depends on the profiles list)
        document.addEventListener('DOMContentLoaded', async function() {
            await loadCustomProfiles();
            renderCustomProfilesList();
        });

        // Add this function to apply a custom profile to all person forms
        function applyCustomProfile(profile) {
            // Apply all fields from the profile to all person forms
            const personForms = document.querySelectorAll('.person-form');
            personForms.forEach(form => {
                Object.keys(profile).forEach(key => {
                    // Skip name/description fields (profile metadata)
                    if (key === 'name' || key === 'description') return;
                    const field = form.elements[key];
                    if (field) {
                        field.value = profile[key];
                        field.setAttribute('data-sandbox-profile', 'true');
                        // If this is a country field, trigger the change event
                        if (key === 'country_code') {
                            field.dispatchEvent(new Event('change'));
                        }
                    }
                });
                // Clear validation errors for all fields in this form
                form.querySelectorAll('input, select, textarea').forEach(field => {
                    const parent = field.parentNode;
                    parent.querySelectorAll('.invalid-feedback').forEach(err => err.remove());
                    field.classList.remove('is-invalid');
                    field.removeAttribute('aria-invalid');
                    if (typeof field.setCustomValidity === 'function') {
                        field.setCustomValidity('');
                    }
                });
            });
            // Show profile indicator
            showProfileIndicator(profile);
            // Optional: Scroll to the submit button to draw attention to it
            const submitButton = document.querySelector('button[type="submit"]');
            if (submitButton) {
                submitButton.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        // Add this function to show the person selection modal for custom profiles
        function showApplyCustomProfileModal(profile) {
            const personForms = document.querySelectorAll('.person-form');
            const modal = document.getElementById('sandboxProfileModal');
            const personList = document.getElementById('sandboxProfilePersonList');
            personList.innerHTML = '';
            // Add ALL option
            const allId = 'sandboxProfileAll';
            const allDiv = document.createElement('div');
            allDiv.className = 'form-check mb-2';
            allDiv.innerHTML = `<input class="form-check-input" type="checkbox" id="${allId}"><label class="form-check-label" for="${allId}"><strong>ALL</strong></label>`;
            personList.appendChild(allDiv);
            // Add each person
            personForms.forEach((form, idx) => {
                const id = `sandboxProfilePerson${idx}`;
                const div = document.createElement('div');
                div.className = 'form-check mb-2';
                div.innerHTML = `<input class="form-check-input" type="checkbox" id="${id}" data-idx="${idx}"><label class="form-check-label" for="${id}">Person ${idx + 1}</label>`;
                personList.appendChild(div);
            });
            // ALL checkbox logic
            const allCheckbox = document.getElementById(allId);
            allCheckbox.addEventListener('change', function() {
                personList.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                    if (cb !== allCheckbox) cb.checked = allCheckbox.checked;
                });
            });
            // If all persons are checked, check ALL
            personList.addEventListener('change', function() {
                const checkboxes = Array.from(personList.querySelectorAll('input[type="checkbox"]')).filter(cb => cb !== allCheckbox);
                allCheckbox.checked = checkboxes.every(cb => cb.checked);
            });
            // Show modal
            modal.style.display = 'flex';
            // If there's only one person, automatically check their box
            if (personForms.length === 1) {
                const singlePersonCheckbox = document.getElementById('sandboxProfilePerson0');
                if (singlePersonCheckbox) {
                    singlePersonCheckbox.checked = true;
                }
            }
            // Cancel button
            document.getElementById('cancelSandboxProfile').onclick = () => {
                modal.style.display = 'none';
            };
            // Confirm button
            document.getElementById('confirmSandboxProfile').onclick = () => {
                // Get selected persons
                const selected = [];
                personList.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                    if (cb !== allCheckbox && cb.checked) selected.push(parseInt(cb.getAttribute('data-idx')));
                });
                // Apply profile only to selected persons
                personForms.forEach((form, idx) => {
                    if (selected.includes(idx)) {
                        Object.keys(profile).forEach(key => {
                            if (key === 'name' || key === 'description') return;
                            const field = form.elements[key];
                            if (field) {
                                field.value = profile[key];
                                field.setAttribute('data-sandbox-profile', 'true');
                                if (key === 'country_code') {
                                    field.dispatchEvent(new Event('change'));
                                }
                            }
                        });
                        // Clear validation errors for all fields in this form
                        form.querySelectorAll('input, select, textarea').forEach(field => {
                            const parent = field.parentNode;
                            parent.querySelectorAll('.invalid-feedback').forEach(err => err.remove());
                            field.classList.remove('is-invalid');
                            field.removeAttribute('aria-invalid');
                            if (typeof field.setCustomValidity === 'function') {
                                field.setCustomValidity('');
                            }
                        });
                    }
                });
                modal.style.display = 'none';
                // Only show profile indicator if at least one person was selected
                if (selected.length > 0) {
                    showProfileIndicator(profile);
                }
                // Optional: Scroll to the submit button to draw attention to it
                const submitButton = document.querySelector('button[type="submit"]');
                if (submitButton) {
                    submitButton.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            };
        }

        // Restore missing functions for custom profiles persistence
        async function loadCustomProfiles() {
            if (window.api && window.api.getCustomProfiles) {
                customProfiles = await window.api.getCustomProfiles() || [];
            } else {
                customProfiles = JSON.parse(localStorage.getItem('customProfiles') || '[]');
            }
        }

        // Global variable to store last submitted data
        let lastSubmittedData = null;

        // Keyboard shortcut for re-running last application
        document.addEventListener('keydown', function(e) {
            // Check if we're in an input or textarea
            const isInput = e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA';

            // Only trigger shortcuts if not in an input field or if it's a specific shortcut
            if (!isInput || e.key === 'Escape') {
                // Command/Control + Shift + E to re-run last app
                if ((e.metaKey || e.ctrlKey) && e.shiftKey && e.key.toLowerCase() === 'e') {
                    e.preventDefault();
                    if (lastSubmittedData) {
                        showNotification("Restoring last application's data to form(s)", 'info');
                        rerunLastApp();
                    } else {
                        showNotification('No previous application data found', 'error');
                    }
                }
            }
        });

        // Initialize Alloy SDK
        const initAlloy = async () => {
            try {
                const config = await fetch('/api/get-config').then(res => res.json());
                const theme = document.body.classList.contains('theme-default') ? 'default' :
                            document.body.classList.contains('theme-red') ? 'red' :
                            document.body.classList.contains('theme-purple') ? 'purple' :
                            document.body.classList.contains('theme-orange') ? 'orange' :
                            document.body.classList.contains('theme-green') ? 'green' : 'default';

                const customStyle = {
                    theme: {
                        primary: theme === 'default' ? '#0052cc' :
                               theme === 'red' ? '#cc0000' :
                               theme === 'purple' ? '#6a0dad' :
                               theme === 'orange' ? '#ff8c00' :
                               theme === 'green' ? '#2e8b57' : '#0052cc'
                    }
                };

                await alloy.init({
                    key: config.ALLOY_SDK_KEY,
                    journeyToken: config.ALLOY_JOURNEY_TOKEN,
                    customStyle: customStyle
                });
            } catch (error) {
                console.error('Error initializing Alloy SDK:', error);
            }
        };

        // Shepherd.js Tour Implementation
        document.getElementById('takeTourBtn').addEventListener('click', function() {
            // Close the Settings & Shortcuts modal if open
            const modalElement = document.getElementById('keyboardShortcutsModal');
            if (modalElement && typeof bootstrap !== 'undefined' && bootstrap.Modal.getInstance(modalElement)) {
                bootstrap.Modal.getInstance(modalElement).hide();
            }
            if (window.Shepherd) {
                const tour = new Shepherd.Tour({
                    defaultStepOptions: {
                        scrollTo: { behavior: 'smooth', block: 'center' },
                        cancelIcon: { enabled: true },
                        classes: document.body.classList.contains('dark-mode') ? 'shepherd-theme-arrows shepherd-dark' : 'shepherd-theme-arrows',
                        modalOverlayOpeningPadding: 6,
                        modalOverlayOpeningRadius: 6
                    }
                });
                tour.addStep({
                    id: 'welcome',
                    text: '👋 Welcome to the Alloy Demo Application! This quick tour will show you the main features.<br><br><h4><strong>Note:</strong> This application is intended for testing and demonstration purposes only. It is not recommended to use this application with production data or any real customer PII of any kind.</h4>',
                    attachToOptions: { allowHtml: true },
                    buttons: [
                        {
                            text: 'Next',
                            action: tour.next
                        }
                    ]
                });
                tour.addStep({
                    id: 'settings',
                    attachTo: { element: '#keyboardShortcutsBtn', on: 'right' },
                    text: 'Click here for Settings & Shortcuts. You can toggle dark mode, developer view, and more.',
                    buttons: [
                        {
                            text: 'Back',
                            action: tour.back
                        },
                        {
                            text: 'Next',
                            action: tour.next
                        }
                    ]
                });
                tour.addStep({
                    id: 'prefill',
                    attachTo: { element: '#prefillBtn', on: 'bottom' },
                    text: 'Use this button to pre-fill the form with dummy data for quick testing.',
                    buttons: [
                        {
                            text: 'Back',
                            action: tour.back
                        },
                        {
                            text: 'Next',
                            action: tour.next
                        }
                    ]
                });
                tour.addStep({
                    id: 'sandbox-profiles',
                    attachTo: { element: '#sandboxProfilesSection .dropdown-toggle', on: 'bottom' },
                    text: 'The Sandbox Profiles dropdown lets you quickly apply test data profiles to your form. You can use built-in profiles or create your own custom profiles for repeatable testing.',
                    buttons: [
                        {
                            text: 'Back',
                            action: tour.back
                        },
                        {
                            text: 'Next',
                            action: tour.next
                        }
                    ]
                });
                tour.addStep({
                    id: 'add-person',
                    attachTo: { element: '#addPersonBtn', on: 'bottom' },
                    text: 'Click here to add a new person to the application.',
                    buttons: [
                        {
                            text: 'Back',
                            action: tour.back
                        },
                        {
                            text: 'Next',
                            action: tour.next
                        }
                    ]
                });
                tour.addStep({
                    id: 'add-business',
                    attachTo: { element: '#addBusinessBtn', on: 'bottom' },
                    text: 'Click here to add a business entity to the application. You can also add business representatives once you add the business.',
                    buttons: [
                        {
                            text: 'Back',
                            action: tour.back
                        },
                        {
                            text: 'Next',
                            action: tour.next
                        }
                    ]
                });
                tour.addStep({
                    id: 'expand-collapse',
                    attachTo: { element: '#toggleAllEntitiesBtn', on: 'bottom' },
                    text: 'Use this button to expand or collapse all sections in the form for easier navigation.',
                    buttons: [
                        {
                            text: 'Back',
                            action: tour.back
                        },
                        {
                            text: 'Next',
                            action: tour.next
                        }
                    ]
                });
                tour.addStep({
                    id: 'fab',
                    attachTo: { element: '#dashboardLinksFab', on: 'left' },
                    text: 'This floating button gives you quick access to recent applications. From there you can jump into that Application in Alloy or re-populate the form with the application data of past applications.',
                    buttons: [
                        {
                            text: 'Back',
                            action: tour.back
                        },
                        {
                            text: 'Next',
                            action: tour.next
                        }
                    ]
                });
                tour.addStep({
                    id: 'dev-section',
                    attachTo: { element: '#devSection', on: 'top' },
                    text: 'This is the Developer Mode section, where you can view request and response data for debugging.',
                    buttons: [
                        {
                            text: 'Back',
                            action: tour.back
                        },
                        {
                            text: 'Finish',
                            action: tour.complete
                        }
                    ]
                });
                tour.start();
            } else {
                alert('Shepherd.js failed to load. Please refresh and try again.');
            }
        });

        // Shepherd.js Tour launcher for first-time users
        async function launchShepherdTourIfFirstTime() {
            let tourShown = false;
            if (window.api && window.api.getTourFlag) {
                tourShown = await window.api.getTourFlag();
            } else {
                tourShown = !!localStorage.getItem('shepherdTourShown');
            }
            if (!tourShown) {
                // Close the Settings & Shortcuts modal if open
                const modalElement = document.getElementById('keyboardShortcutsModal');
                if (modalElement && typeof bootstrap !== 'undefined' && bootstrap.Modal.getInstance(modalElement)) {
                    bootstrap.Modal.getInstance(modalElement).hide();
                }
                if (window.Shepherd) {
                    // Use the same tour logic as the Take a Tour button
                    document.getElementById('takeTourBtn').click();
                    if (window.api && window.api.setTourFlag) {
                        await window.api.setTourFlag(true);
                    } else {
                        localStorage.setItem('shepherdTourShown', 'true');
                    }
                }
            }
        }
        // After config is validated and page is ready, launch the tour if needed
        document.addEventListener('DOMContentLoaded', function() {
            // Only launch if config is valid (i.e., not redirected to config.html)
            fetch('/api/config').then(res => {
                if (res.ok) {
                    launchShepherdTourIfFirstTime();
                }
            });
        });

        document.querySelectorAll('#rerunLastAppBtn').forEach(function(btn) {
            btn.addEventListener('click', function() {
                // Always set lastSubmittedData to the most recent application before rerunning
                if (window.applicationLinks && window.applicationLinks.length > 0) {
                    const mostRecent = window.applicationLinks[0];
                    if (mostRecent && mostRecent.data) {
                        lastSubmittedData = JSON.parse(JSON.stringify(mostRecent.data));
                    }
                }
                rerunLastApp();
            });
        });

        // Add this after the definition of initializeAlloySDK and after journey_application_token is first used
        let lastJourneyApplicationToken = null;
        let sdkStepUpAvailable = false;

        const originalInitializeAlloySDK = window.initializeAlloySDK || initializeAlloySDK;
        window.initializeAlloySDK = async function(journeyApplicationToken) {
            lastJourneyApplicationToken = journeyApplicationToken;
            sdkStepUpAvailable = true;
            // Show the button if on Under Review
            const btn = document.getElementById('reinitSDKBtn');
            if (btn && document.getElementById('manualReviewMessage').style.display === 'block') {
                btn.style.display = '';
            }
            return originalInitializeAlloySDK(journeyApplicationToken);
        };

        // Add event listener for the reinitSDKBtn
        function setupReinitSDKBtn() {
            const btn = document.getElementById('reinitSDKBtn');
            if (!btn) return;
            btn.addEventListener('click', async function() {
                if (!lastJourneyApplicationToken) {
                    showNotification('No verification session available to re-initialize.', 'error');
                    return;
                }
                showProcessingModal('Re-initializing verification...');
                try {
                    await window.initializeAlloySDK(lastJourneyApplicationToken);
                } catch (err) {
                    showNotification('Failed to re-initialize verification: ' + err.message, 'error');
                } finally {
                    hideProcessingModal();
                }
            });
        }

        // Call setupReinitSDKBtn after DOMContentLoaded
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', setupReinitSDKBtn);
        } else {
            setupReinitSDKBtn();
        }

        // 4. Reset flags when starting a new app or navigating away
        function resetSDKStepUpState() {
            sdkStepUpAvailable = false;
            lastJourneyApplicationToken = null;
            const btn = document.getElementById('reinitSDKBtn');
            if (btn) btn.style.display = 'none';
        }
        // Call resetSDKStepUpState on new app, rerun, or run-another-app-btn
        // Add event listeners after DOMContentLoaded
        function setupResetSDKStepUpState() {
            document.querySelectorAll('.run-another-app-btn, #rerunLastAppBtn').forEach(btn => {
                btn.addEventListener('click', resetSDKStepUpState);
            });
        }
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', setupResetSDKStepUpState);
        } else {
            setupResetSDKStepUpState();
        }

        document.addEventListener('DOMContentLoaded', function() {
            if (localStorage.getItem('hasBusinessesBranch') !== 'true') {
                var btn = document.getElementById('addBusinessBtn');
                if (btn) btn.style.display = 'none';
            }
        });
    </script>

</body>
</html> 